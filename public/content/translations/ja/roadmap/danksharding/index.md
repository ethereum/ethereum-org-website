---
title: ダークシャーディング
description: イーサリアムをスケーリングするための2段階のアップグレードである、プロトダンクシャーディングとダンクシャーディングについて学びます。
lang: ja
summaryPoints:
  - ダンクシャーディングは、イーサリアムのスケーラビリティと容量を向上させるための複数のフェーズを伴うアップグレードです。
  - 最初のステージであるプロトダンクシャーディングでは、ブロックにデータブロブを追加します。
  - データブロブにより、ロールアップがイーサリアムにデータを投稿するコストが削減されます。これにより、ユーザーはトランザクションフィーを安く抑えることができます。
  - その後、完全なダンクシャーディングは、データブロブの検証責任をノードのサブセット全体に広げ、さらにイーサリアムのスケーリングを1秒間のトランザクション件数を10万件以上に拡張します。
---

# ダークシャーディング {#danksharding}

**ダンクシャーディング**は、イーサリアムが真にスケーラブルなブロックチェーンになるうえで重要な役割を果たしています。しかし、そこに到達するには、複数のプロトコルをアップグレードする必要があります。 **プロトダンクシャーディング**は、ダンクシャーディングへの中間ステップです。 どちらもユーザーにとってレイヤー2でのトランザクションを可能な限り安価にすることを目的としています。また、イーサリアムを1秒間のトランザクション件数を10万件以上に拡大することを目指しています。

## プロトダンクシャーディングとは {#what-is-protodanksharding}

[EIP-4844](https://eips.ethereum.org/EIPS/eip-4844)として知られるプロトダンクシャーディングは、[ロールアップ](/layer-2/#rollups)がより安価なデータをブロックに追加する方法です。 この名称は、アイデアを提案した2名の研究者 (プロトラムダ氏とダンクラッド・フィースト氏)に由来しています。 現在のシステムでは、ロールアップは`CALLDATA`にトランザクションを投稿するため、ユーザートランザクションのコストを安くするには限界があります。 たとえロールアップがデータを必要とするのが短期間であっても、すべてのイーサリアムノードによって処理され、チェーン上にデータが永久に存在するため高価になってしまいます。 プロトダンクシャーディングでは、ブロックに送信、添付できるデータブロブを導入します。 これらのブロブ内のデータは、EVMにアクセスできず、一定期間 (1～3か月) が経過すると自動的に削除されます。 データブロブにより、ロールアップはデータをより安価に送信できるため、節約した費用をトランザクションのコストとして削減することができます。これにより、エンドユーザーはより安価にトランザクションを行うことができます。

<ExpandableCard title="なぜブロブでロールアップを安くできるのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why do blocks make rollups cheaper?">

ロールアップは、トランザクションをオフチェーンでバッチ処理し、その結果をイーサリアムに投稿することで、イーサリアムをスケーラビリティを改善する方法です。 ロールアップは、基本的にデータと実行確認の2つの要素で構成されています。 データは、イーサリアムに投稿される状態変更を生成するためにロールアップによって処理されている、トランザクションの完全なシーケンスです。 実行確認では、正直なアクターである証明者が、提案された状態変更が正しいことを確認するために、トランザクションを再度実行します。 実行確認を行うには、誰でもダウンロードして確認できるように、トランザクションデータの公開期間を十分に設けておく必要があります。 実行確認により、証明者は、ロールアップシーケンサーが行った不正行為を特定でき、異議申立をすることができます。 ただし、このトランザクションデータを永久的に保存する必要はありません。

</ExpandableCard>

<ExpandableCard title="なぜブロブデータを削除するのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why is it OK to delete the blob data?">

ロールアップは、トランザクションデータへのコミットメントをオンチェーンに投稿し、実際のデータをデータブロブで入手できるようにするため、 証明者はコミットメントが有効であることを確認したり、間違っていると思われるデータに異議を唱えることができます。 ノードレベルでは、データブロブはコンセンサスクライアントに保持されます。 コンセンサスクライアントは、データを確認し、それがネットワーク全体に伝播したことを証明します。 データが永久的に保持される場合、これらのクライアントの容量が大きくなり、ノードの実行に大量のハードウェアが必要になる可能性があります そのため、データは1～3か月ごとにノードから自動的に削除されます。 コンセンサスクライアントのアテステーションは、証明者がデータを十分に検証する機会があったことを示しています。 実際のデータは、ロールアップオペレータやユーザーなどがオフチェーンに保存できます。

</ExpandableCard>

### ブロブデータの検証方法 {#how-are-blobs-verified}

ロールアップは、データブロブ内で実行されるトランザクションと、 データを示す「コミットメント」をイーサリアムに投稿します。 これは、多項式関数をデータに当てはめることによって行われます。 この関数は様々な点で値を求めることができます。 例えば、非常に単純な関数`f(x) = 2x-1`を定義したとして、この関数の点である`x = 1`、`x = 2`、`x = 3`で値を求めると、結果は、`1、3、5`になります。 証明者は、同じ関数をデータに適用し、同じ点で値を求めます。 元のデータが変更された場合は、関数は同一ではなくなり、そのため各点で算出される値も同一ではなくなります。 実際には、コミットメントと証明は暗号関数でラップされているため、より複雑になっています。

### KZGとは {#what-is-kzg}

KZGは、Kate-Zaverucha-Goldbergの頭文字で、これは3人の[原作者](https://link.springer.com/chapter/10.1007/978-3-642-17373-8_11)の名前を表しています。 データのブロブを小さな[暗号「コミットメント」](https://dankradfeist.de/ethereum/2020/06/16/kate-polynomial-commitments.html) まで縮小するスキームのことです。 ロールアップによって送信されたデータブロブは、ロールアップが不正な動作を行っていないか確認するために検証する必要があります。 そのためには、証明者がブロブ内のトランザクションを再実行して、コミットメントが正しいことを確認します。 これは、実行クライアントがマークルプルーフを使用してレイヤー1上のイーサリアムトランザクションの正当性をチェックする方法と、概念的には同じです。 KZGは、多項式をデータに当てはめる代替証明です。 コミットメントは、秘密になっている複数のデータ点で多項式を評価します。 証明者は、データに対して同じ多項式と同じ値で評価し、結果が同じであることを確認します。 これは、ゼロ知識技術と互換性のあるデータ検証方式であり、一部のロールアップやイーサリアムプロトコルの他の箇所で使用されています。

### KZGセレモニーとは {#what-is-a-kzg-ceremony}

KZGセレモニーは、イーサリアムコミュニティ全体から多くの人々が協力して生成する、データの検証に使用できる秘密のランダムな数字列を生成する方法です。 この数字列は、誰にも知られず、誰にも再現できないことが、非常に重要であり、 そのために、セレモニーに参加する各人は、前の参加者から文字列を受け取ります。 次に、ブラウザにマウスの動きを測定させるなどして、いくつかの新しいランダム値を作成します。それを以前の値と混ぜて、 次の参加者に送信し、送信後にローカルマシンからその値を破棄します。 セレモニーに参加する1人がこれを正直に行う限り、最終的な値が攻撃者に判明することはありません。 EIP-4844のKZGセレモニーは一般公開され、何万人もの人々がエントロピーを追加するために参加しました。 セレモニーを妨害するためには、参加者の100%が積極的に不正行為を行わなければなりません。 参加者の観点では、自分自身が正直であるとわかっていれば、その人自身がセレモニーの安全を確保したことがわかるので、他の人を信頼する必要はありません(参加者が個々に、N人中1人の正直な参加者の要件を満たしています) 。

<ExpandableCard title="KZGセレモニーの乱数は何に使用されるのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why is the random number from the KZG ceremony used for?">

ロールアップがデータをブロブに投稿すると、チェーン上に投稿するという「コミットメント」を提供します。 このコミットメントは、特定の点でデータに適合する多項式を評価した結果です。 この点は、KZGセレモニーで生成された乱数によって定義され、 証明者はデータを検証するために同じ点で多項式を評価できます。同じ値になった場合、データは正しいということになります。

</ExpandableCard>

<ExpandableCard title="なぜKZG乱数データは秘密にしなければならないのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why does the KZG random data have to stay secret?">

コミットメントに使用されるランダムな位置を知っている者にとっては、それらの特定の点(すなわち「コリジョン」)に適合する新しい多項式を生成するのは簡単です。 つまり、ブロブにデータを追加または削除しても、有効な証拠を提供できてしまうのです。 これを防ぐために、秘密の位置をそのまま提供する代わりに、楕円曲線を使用して暗号化された「ブラックボックス」でラップされた位置を証明者に提供します。 こうした値は、元の値をリバースエンジニアリングできないように値を効果的にスクランブルしますが、いくつかの巧妙な代数的操作により、証明者と検証者はそれらが表す点で多項式を評価することができます。

</ExpandableCard>

<InfoBanner isWarning mb={8}>
  ダンクシャーディングもプロトダンクシャーディングも、ブロックチェーンを複数の部分に分割しようとした従来の「シャーディング」モデルとは異なるものです。 シェアードチェーンは、すでにロードマップから削除されています。 代わりに、ダンクシャーディングが採用されており、ブロブ横断する分散データサンプリングを使うことで、イーサリアムをスケーリングします。 この方法ははるかに実装が容易であり、 「データシャーディング」と呼ばれることもあります。
</InfoBanner>

## ダンクシャーディングとは {#what-is-danksharding}

ダンクシャーディングは、プロトダンクシャーディングで始まったロールアップスケーリングの完成版です。 ダンクシャーディングは、イーサリアムに大容量のスペースをもたらし、ロールアップのトランザクションデータを圧縮して保存できるようにします。 これにより、イーサリアムは数百ものロールアップを簡単にサポートでき、毎秒数百万のトランザクションを処理できるようになります。

この仕組みを説明すると、ブロックに添付されるブロブをプロトダンクシャーディングの1個から完全なダンクシャーディングである64個まで拡張する方法を導入することで機能します。 必要な残りの変更は、新しい大きなブロブを処理できるようにするためにコンセンサスクライアントの動作方法をすべて更新することです。 これらの変更の中には、ダンクシャーディングとは関係なく、別の目的のためにすでに計画されているものもあります。 例えば、ダンクシャーディングでは、提案者と作成者の分離が実装されている必要があります。 これは、さまざまなバリデータ間でブロックの作成とブロックの提案のタスクを分離するアップグレードです。 同様に、ダンクシャーディングにはデータ可用性のサンプリングが必要ですが、多くの履歴データを保存しない超軽量クライアント「ステートレスクライアント」の開発にも必要です。

<ExpandableCard title="なぜダンクシャーディングでは提案者と作成者の分離が必要なのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why does danksharding require proposer-builder separation?">

提案者と作成者を分離することで、個々の検証者が32MBのブロブデータに対して、コストのかかるコミットメントや証明を生成するのを防ぐことができます。 提案者と作成者の分離をしないと、自宅でステーキングをしている端末に過度の負担がかかり、より強力なハードウェアへの投資が必要となります。その結果、分散化に悪影響を及ぼします。 代わりに、専門のブロック作成者が、このコストのかかる計算作業を担当します。 そして、ブロック作成者は、ブロック提案者にブロックを提供してブロードキャストします。 ブロック提案者は、最も収益性の高いブロックを選択するだけです。 誰でも、安価かつ迅速にブロブを検証できます。つまり、通常のバリデータであれば、ブロック作成者が誠実な行動をしているかどうかをチェックできます。 この仕組みにより、分散化を犠牲にすることなく、大きなブロブを処理することができます。 不正なブロック作成者を簡単にネットワークから排除してスラッシュすることができます。ブロック作成自体が収益性の高い活動であるため、不正なブロック作成者の代わりに、他の候補者が参加することになります。

</ExpandableCard>

<ExpandableCard title="なぜダンクシャーディングには、データ可用性サンプリングが必要なのですか？" eventCategory="/roadmap/danksharding" eventName="clicked why does danksharding require data availability sampling?">

データ可用性サンプリングは、バリデータがブロブデータを迅速かつ効率的に検証するために必要です。 データ可用性サンプリングによって、バリデータは、ブロブデータが利用可能であり、正しくコミットされていることを確認できます。 具体的には、バリデータは、いくつかのデータ点をランダムにサンプリングして、そのデータがきちんと保存されていることを確認します。つまり、ブロブ全体をチェックする必要はありません。 データが欠落していた場合、すぐに特定してそのブロブを拒否することができます。

</ExpandableCard>

### 現在の進行状況 {#current-progress}

完全なダンクシャーディングは、数年先を予定していますが、 プロトダンクシャーディングは、近日にリリースされます。 この記事の執筆時点(2023年2月)において、KZGセレモニーはまだ開催中であり、これまでに5万人以上の参加者を集めています。 プロトダンクシャーディングの[EIP](https://eips.ethereum.org/EIPS/eip-4844)は完成に近づいており、仕様も合意に至っています。現在、クライアントのテストが行われており、本番環境に導入するためのプロトタイプが実装されています。 次のステップは、公開テストネット上で変更を実装することです。 [EIP 4844準備チェックリスト](https://github.com/ethereum/pm/blob/master/Dencun/4844-readiness-checklist.md)を使うことで、最新の状況を把握することができます。

### 参考文献 {#further-reading}

- [プロトダンクシャーディングのメモ](https://notes.ethereum.org/@vbuterin/proto_danksharding_faq) - _ヴィタリック・ブテリン_
- [ダンクシャーディングに関するダンクラッドのメモ](https://notes.ethereum.org/@dankrad/new_sharding)
- [ダンクラッド、プロト、ヴィタリックによるダンクシャーディングの議論](https://www.youtube.com/watch?v=N5p0TB77flM)
- [KZGセレモニー](https://ceremony.ethereum.org/)
- [信頼されたセットアップに関するカール・ベークハウゼン(Carl Beekhuizen)のDevconでのトーク](https://archive.devcon.org/archive/watch/6/the-kzg-ceremony-or-how-i-learnt-to-stop-worrying-and-love-trusted-setups/?tab=YouTube)
- [ブロブ向けのデータ可用性サンプリングの詳細](https://hackmd.io/@vbuterin/sharding_proposal#ELI5-data-availability-sampling)
- [ダンクラッド・フィーストによるKZGコミットメントと証明](https://youtu.be/8L2C6RDMV9Q)
- [KZG多項式コミットメント](https://dankradfeist.de/ethereum/2020/06/16/kate-polynomial-commitments.html)
