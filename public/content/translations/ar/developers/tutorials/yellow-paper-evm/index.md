---
title: "فهم مواصفات آلة الإيثيريوم الافتراضية (EVM) في الورقة الصفراء"
description: "فهم جزء الورقة الصفراء، والمواصفات الرسمية لإيثيريوم، الذي يشرح آلة إيثيريوم الافتراضية (EVM)."
author: "qbzzt"
tags: [ "evm" ]
skill: intermediate
lang: ar
published: 2022-05-15
---

[الورقة الصفراء](https://ethereum.github.io/yellowpaper/paper.pdf) هي المواصفات الرسمية لإيثيريوم. باستثناء ما تم تعديله من خلال [عملية مقترحات تحسين إيثريوم (EIP)](/eips/)، فهي تحتوي على الوصف الدقيق لكيفية عمل كل شيء. إنها مكتوبة كورقة رياضية، والتي تتضمن مصطلحات قد لا يجدها المبرمجون مألوفة. في هذه الورقة، ستتعلم كيفية قراءتها، وبالتالي الأوراق الرياضية الأخرى ذات الصلة.

## أي ورقة صفراء؟ {#which-yellow-paper}

مثل كل شيء آخر تقريبًا في إيثريوم، تتطور الورقة الصفراء بمرور الوقت. للتمكن من الإشارة إلى إصدار معين، قمت بتحميل [الإصدار الحالي وقت الكتابة](yellow-paper-berlin.pdf). ستشير أرقام الأقسام والصفحات والمعادلات التي أستخدمها إلى ذلك الإصدار. من الجيد إبقاؤها مفتوحة في نافذة مختلفة أثناء قراءة هذا المستند.

### لماذا آلة الإيثيريوم الافتراضية (EVM)؟ {#why-the-evm}

كُتبت الورقة الصفراء الأصلية في بداية تطوير إيثريوم. تصف آلية الإجماع الأصلية القائمة على إثبات العمل والتي تم استخدامها في الأصل لتأمين الشبكة. ومع ذلك، أوقفت إيثريوم إثبات العمل وبدأت في استخدام الإجماع القائم على إثبات الحصة في سبتمبر 2022. سيركز هذا البرنامج التعليمي على أجزاء الورقة الصفراء التي تحدد آلة إيثريوم الافتراضية. لم تتغير آلة الإيثيريوم الافتراضية (EVM) مع الانتقال إلى إثبات الحصة (باستثناء القيمة المرجعة لرمز التشغيل DIFFICULTY).

## 9 نموذج التنفيذ {#9-execution-model}

يتضمن هذا القسم (صفحة 12-14) معظم تعريف آلة الإيثيريوم الافتراضية (EVM).

يتضمن مصطلح _حالة النظام_ كل ما تحتاج إلى معرفته عن النظام لتشغيله. في الحاسوب العادي، هذا يعني الذاكرة، ومحتوى المسجلات، وما إلى ذلك.

إن [آلة تورنغ](https://en.wikipedia.org/wiki/Turing_machine) هي نموذج حسابي. في الأساس، هي نسخة مبسطة من الحاسوب، والتي ثبت أن لديها نفس القدرة على إجراء العمليات الحسابية التي يمكن للحاسوب العادي إجراؤها (كل ما يمكن للحاسوب حسابه يمكن لآلة تورنغ حسابه والعكس صحيح). يسهل هذا النموذج إثبات النظريات المختلفة حول ما هو قابل للحساب وما هو غير قابل للحساب.

يعني مصطلح [Turing-complete](https://en.wikipedia.org/wiki/Turing_completeness) الحاسوب الذي يمكنه إجراء نفس العمليات الحسابية مثل آلة تورنغ. يمكن أن تدخل آلات تورنغ في حلقات لا نهائية، ولا يمكن لآلة الإيثيريوم الافتراضية (EVM) ذلك لأنها ستنفد من الغاز، لذا فهي شبه كاملة تورنغيًا فقط.

## 9.1 الأساسيات {#91-basics}

يقدم هذا القسم أساسيات آلة الإيثيريوم الافتراضية (EVM) وكيفية مقارنتها بالنماذج الحسابية الأخرى.

إن [آلة المكدس](https://en.wikipedia.org/wiki/Stack_machine) هي حاسوب يخزن البيانات الوسيطة ليس في المسجلات، ولكن في [**مكدس**](https://en.wikipedia.org/wiki/Stack_\(abstract_data_type\)). هذه هي البنية المفضلة للآلات الافتراضية لأنه من السهل تنفيذها مما يعني أن الأخطاء والثغرات الأمنية أقل احتمالًا. تنقسم الذاكرة في المكدس إلى كلمات بحجم 256 بت. تم اختيار هذا لأنه مناسب لعمليات التشفير الأساسية لإيثيريوم مثل تجزئة (هاش) Keccak-256 وحسابات المنحنى الإهليلجي. الحد الأقصى لحجم المكدس هو 1024 عنصرًا (1024 × 256 بت). عندما يتم تنفيذ رموز التشغيل، فإنها عادة ما تحصل على معلمات من المكدس. هناك رموز تشغيل خاصة بإعادة تنظيم العناصر في المكدس مثل `POP` (إزالة عنصر من أعلى المكدس)، و`DUP_N` (تكرار العنصر N في المكدس)، وما إلى ذلك.

تمتلك آلة الإيثيريوم الافتراضية (EVM) أيضًا مساحة متطايرة تسمى **الذاكرة** والتي تستخدم لتخزين البيانات أثناء التنفيذ. تنظم هذه الذاكرة في كلمات بحجم 32 بايت. يتم تهيئة جميع مواقع الذاكرة إلى الصفر. إذا قمت بتنفيذ نص [Yul](https://docs.soliditylang.org/en/latest/yul.html) البرمجي هذا لإضافة كلمة إلى الذاكرة، فسيملأ 32 بايتًا من الذاكرة عن طريق حشو المساحة الفارغة في الكلمة بالأصفار، أي أنه ينشئ كلمة واحدة - مع أصفار في المواقع من 0 إلى 29، و0x60 في الموقع 30، و0xA7 في الموقع 31.

```yul
mstore(0, 0x60A7)
```

`mstore` هو واحد من ثلاثة رموز تشغيل توفرها آلة الإيثيريوم الافتراضية (EVM) للتفاعل مع الذاكرة - فهو يقوم بتحميل كلمة في الذاكرة. الاثنان الآخران هما `mstore8` الذي يقوم بتحميل بايت واحد في الذاكرة، و`mload` الذي ينقل كلمة من الذاكرة إلى المكدس.

لدى آلة الإيثيريوم الافتراضية (EVM) أيضًا نموذج **تخزين** منفصل غير متطاير يتم الحفاظ عليه كجزء من حالة النظام - يتم تنظيم هذه الذاكرة في مصفوفات كلمات (بدلاً من مصفوفات البايتات القابلة للعنونة بالكلمات في المكدس). هذا التخزين هو المكان الذي تحتفظ فيه العقود بالبيانات الثابتة - يمكن للعقد التفاعل فقط مع التخزين الخاص به. يتم تنظيم التخزين في تعيينات المفتاح-القيمة.

على الرغم من أنه لم يتم ذكره في هذا القسم من الورقة الصفراء، فمن المفيد أيضًا معرفة أن هناك نوعًا رابعًا من الذاكرة. **بيانات الاستدعاء (Calldata)** هي ذاكرة للقراءة فقط قابلة للعنونة بالبايت تُستخدم لتخزين القيمة التي تم تمريرها مع معلمة `data` الخاصة بالمعاملة. تحتوي آلة الإيثيريوم الافتراضية (EVM) على رموز تشغيل محددة لإدارة `calldata`. يقوم `calldatasize` بإرجاع حجم البيانات. يقوم `calldataload` بتحميل البيانات في المكدس. يقوم `calldatacopy` بنسخ البيانات إلى الذاكرة.

تخزن [بنية فون نيومان](https://en.wikipedia.org/wiki/Von_Neumann_architecture) القياسية النص البرمجي والبيانات في نفس الذاكرة. لا تتبع آلة الإيثيريوم الافتراضية (EVM) هذا المعيار لأسباب أمنية - فمشاركة الذاكرة المتطايرة تجعل من الممكن تغيير النص البرمجي للبرنامج. بدلاً من ذلك، يتم حفظ النص البرمجي في التخزين.

هناك حالتان فقط يتم فيهما تنفيذ النص البرمجي من الذاكرة:

- عندما يقوم عقد بإنشاء عقد آخر (باستخدام [`CREATE`](https://www.evm.codes/#f0) أو [`CREATE2`](https://www.evm.codes/#f5))، يأتي النص البرمجي لمنشئ العقد من الذاكرة.
- أثناء إنشاء _أي_ عقد، يتم تشغيل النص البرمجي للمُنشئ ثم يُرجع النص البرمجي للعقد الفعلي، من الذاكرة أيضًا.

يعني مصطلح التنفيذ الاستثنائي استثناءً يؤدي إلى توقف تنفيذ العقد الحالي.

## 9.2 نظرة عامة على الرسوم {#92-fees-overview}

يشرح هذا القسم كيفية حساب رسوم الغاز. هناك ثلاث تكاليف:

### تكلفة رمز التشغيل {#opcode-cost}

التكلفة المتأصلة لرمز التشغيل المحدد. للحصول على هذه القيمة، ابحث عن مجموعة التكلفة لرمز التشغيل في الملحق H (صفحة 28، تحت المعادلة (327))، وابحث عن مجموعة التكلفة في المعادلة (324). يمنحك هذا دالة تكلفة، والتي تستخدم في معظم الحالات معلمات من الملحق G (صفحة 27).

على سبيل المثال، رمز التشغيل [`CALLDATACOPY`](https://www.evm.codes/#37) هو عضو في المجموعة _W<sub>copy</sub>_. تكلفة رمز التشغيل لتلك المجموعة هي _G<sub>verylow</sub>+G<sub>copy</sub>×⌈μ<sub>s</sub>[2]÷32⌉_. بالنظر إلى الملحق G، نرى أن كلا الثابتين هما 3، مما يعطينا _3+3×⌈μ<sub>s</sub>[2]÷32⌉_.

لا يزال يتعين علينا فك شفرة التعبير _⌈μ<sub>s</sub>[2]÷32⌉_. الجزء الخارجي، _⌈ \<value\> ⌉_ هو دالة السقف، وهي دالة تُعطى قيمة وتعيد أصغر عدد صحيح لا يزال ليس أصغر من القيمة. على سبيل المثال، _⌈2.5⌉ = ⌈3⌉ = 3_. الجزء الداخلي هو _μ<sub>s</sub>[2]÷32_. بالنظر إلى القسم 3 (الاصطلاحات) في الصفحة 3، _μ_ هي حالة الآلة. يتم تعريف حالة الآلة في القسم 9.4.1 في الصفحة 13. وفقًا لذلك القسم، فإن أحد معلمات حالة الآلة هو _s_ للمكدس. بجمع كل ذلك معًا، يبدو أن _μ<sub>s</sub>[2]_ هو الموقع رقم 2 في المكدس. بالنظر إلى [رمز التشغيل](https://www.evm.codes/#37)، فإن الموقع رقم 2 في المكدس هو حجم البيانات بالبايت. بالنظر إلى رموز التشغيل الأخرى في المجموعة W<sub>copy</sub>، و[`CODECOPY`](https://www.evm.codes/#39) و[`RETURNDATACOPY`](https://www.evm.codes/#3e)، فإنها تحتوي أيضًا على حجم من البيانات في نفس الموقع. إذًا _⌈μ<sub>s</sub>[2]÷32⌉_ هو عدد الكلمات بحجم 32 بايت اللازمة لتخزين البيانات التي يتم نسخها. بجمع كل شيء معًا، التكلفة المتأصلة لـ [`CALLDATACOPY`](https://www.evm.codes/#37) هي 3 غاز بالإضافة إلى 3 لكل كلمة من البيانات التي يتم نسخها.

### تكلفة التشغيل {#running-cost}

تكلفة تشغيل النص البرمجي الذي نستدعيه.

- في حالة [`CREATE`](https://www.evm.codes/#f0) و[`CREATE2`](https://www.evm.codes/#f5)، يكون هو منشئ العقد الجديد.
- في حالة [`CALL`](https://www.evm.codes/#f1)، أو [`CALLCODE`](https://www.evm.codes/#f2)، أو [`STATICCALL`](https://www.evm.codes/#fa)، أو [`DELEGATECALL`](https://www.evm.codes/#f4)، يكون هو العقد الذي نستدعيه.

### تكلفة توسيع الذاكرة {#expanding-memory-cost}

تكلفة توسيع الذاكرة (إذا لزم الأمر).

في المعادلة 324، تكتب هذه القيمة على النحو التالي _C<sub>mem</sub>(μ<sub>i</sub>')-C<sub>mem</sub>(μ<sub>i</sub>)_. بالنظر إلى القسم 9.4.1 مرة أخرى، نرى أن _μ<sub>i</sub>_ هو عدد الكلمات في الذاكرة. إذًا _μ<sub>i</sub>_ هو عدد الكلمات في الذاكرة قبل رمز التشغيل و_μ<sub>i</sub>'_ هو عدد الكلمات في الذاكرة بعد رمز التشغيل.

تعرَّف الدالة _C<sub>mem</sub>_ في المعادلة 326: _C<sub>mem</sub>(a) = G<sub>memory</sub> × a + ⌊a<sup>2</sup> ÷ 512⌋_. _⌊x⌋_ هي دالة الأرضية، وهي دالة تُعطى قيمة وتعيد أكبر عدد صحيح لا يزال ليس أكبر من القيمة. على سبيل المثال، _⌊2.5⌋ = ⌊2⌋ = 2._ عندما تكون _a < √512_، فإن _a<sup>2</sup> < 512_، وتكون نتيجة دالة الأرضية صفرًا. لذلك بالنسبة لأول 22 كلمة (704 بايت)، ترتفع التكلفة خطيًا مع عدد كلمات الذاكرة المطلوبة. بعد هذه النقطة، يكون _⌊a<sup>2</sup> ÷ 512⌋_ موجبًا. عندما تكون الذاكرة المطلوبة عالية بما يكفي، تتناسب تكلفة الغاز مع مربع كمية الذاكرة.

**ملاحظة** أن هذه العوامل تؤثر فقط على تكلفة الغاز _المتأصلة_ - فهي لا تأخذ في الحسبان سوق الرسوم أو الإكراميات لبرامج المدققين التي تحدد المبلغ الذي يطلب من المستخدم النهائي دفعه - هذه مجرد التكلفة الأولية لتشغيل عملية معينة على آلة الإيثيريوم الافتراضية (EVM).

[اقرأ المزيد عن الغاز](/developers/docs/gas/).

## 9.3 بيئة التنفيذ {#93-execution-env}

بيئة التنفيذ هي مجموعة، _I_، تتضمن معلومات ليست جزءًا من حالة البلوك تشين أو آلة الإيثيريوم الافتراضية (EVM).

| Parameter       | رمز التشغيل للوصول إلى البيانات                                                                       | نص Solidity البرمجي للوصول إلى البيانات                  |
| --------------- | ----------------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| _I<sub>a</sub>_ | [`ADDRESS`](https://www.evm.codes/#30)                                                                | `address(this)`                                          |
| _I<sub>o</sub>_ | [`ORIGIN`](https://www.evm.codes/#32)                                                                 | `tx.origin`                                              |
| _I<sub>p</sub>_ | [`GASPRICE`](https://www.evm.codes/#3a)                                                               | `tx.gasprice`                                            |
| _I<sub>d</sub>_ | [`CALLDATALOAD`](https://www.evm.codes/#35)، إلخ.                                     | `msg.data`                                               |
| _I<sub>s</sub>_ | [`CALLER`](https://www.evm.codes/#33)                                                                 | `msg.sender`                                             |
| _I<sub>v</sub>_ | [`CALLVALUE`](https://www.evm.codes/#34)                                                              | `msg.value`                                              |
| _I<sub>b</sub>_ | [`CODECOPY`](https://www.evm.codes/#39)                                                               | `address(this).code`                                     |
| _I<sub>H</sub>_ | حقول رأس الكتلة، مثل [`NUMBER`](https://www.evm.codes/#43) و[`DIFFICULTY`](https://www.evm.codes/#44) | `block.number`، `block.difficulty`، إلخ. |
| _I<sub>e</sub>_ | عمق مكدس الاستدعاءات للمكالمات بين العقود (بما في ذلك إنشاء العقد)                 |                                                          |
| _I<sub>w</sub>_ | هل يُسمح لآلة الإيثيريوم الافتراضية (EVM) بتغيير الحالة، أم أنها تعمل بشكل ثابت    |                                                          |

هناك عدد قليل من المعلمات الأخرى الضرورية لفهم بقية القسم 9:

| Parameter | مُعرَّف في القسم                                               | المعنى                                                                                                                                                                                                 |
| --------- | -------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| _σ_       | 2 (ص. 2، المعادلة 1)        | حالة البلوك تشين                                                                                                                                                                                       |
| _g_       | 9.3 (ص. 13) | الغاز المتبقي                                                                                                                                                                                          |
| _A_       | 6.1 (ص. 8)  | الحالة الفرعية المتراكمة (التغييرات المجدولة عند انتهاء المعاملة)                                                                                                                   |
| _o_       | 9.3 (ص. 13) | الناتج - النتيجة المرجعة في حالة المعاملة الداخلية (عندما يستدعي عقد عقدًا آخر) واستدعاءات دوال العرض (عندما تطلب معلومات فقط، لذلك لا توجد حاجة لانتظار معاملة) |

## 9.4 نظرة عامة على التنفيذ {#94-execution-overview}

الآن بعد أن أصبحت لدينا كل المعلومات التمهيدية، يمكننا أخيرًا البدء في العمل على كيفية عمل آلة الإيثيريوم الافتراضية (EVM).

تعطينا المعادلات من 137 إلى 142 الشروط الأولية لتشغيل آلة الإيثيريوم الافتراضية (EVM):

| الرمز            | القيمة الأولية                                                                   | المعنى                                                                                                                                                                                                                                                                                      |
| ---------------- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| _μ<sub>g</sub>_  | _g_                                                                              | الغاز المتبقي                                                                                                                                                                                                                                                                               |
| _μ<sub>pc</sub>_ | _0_                                                                              | عداد البرنامج، عنوان التعليمة التالية المراد تنفيذها                                                                                                                                                                                                                                        |
| _μ<sub>m</sub>_  | _(0, 0, ...)_ | الذاكرة، مهيأة إلى كل الأصفار                                                                                                                                                                                                                                                               |
| _μ<sub>i</sub>_  | _0_                                                                              | أعلى موقع ذاكرة مستخدم                                                                                                                                                                                                                                                                      |
| _μ<sub>s</sub>_  | _()_                                                          | المكدس، فارغ في البداية                                                                                                                                                                                                                                                                     |
| _μ<sub>o</sub>_  | _∅_                                                                              | الناتج، مجموعة فارغة حتى نتوقف إما مع بيانات الإرجاع ([`RETURN`](https://www.evm.codes/#f3) أو [`REVERT`](https://www.evm.codes/#fd)) أو بدونها ([`STOP`](https://www.evm.codes/#00) أو [`SELFDESTRUCT`](https://www.evm.codes/#ff)). |

تخبرنا المعادلة 143 بوجود أربع حالات محتملة في كل نقطة زمنية أثناء التنفيذ، وماذا نفعل بها:

1. `Z(σ,μ,A,I)`. تمثل Z دالة تختبر ما إذا كانت العملية تنشئ انتقال حالة غير صالح (راجع [التوقف الاستثنائي](#942-exceptional-halting)). إذا تم تقييمها على أنها True، فإن الحالة الجديدة مطابقة للحالة القديمة (باستثناء حرق الغاز) لأن التغييرات لم يتم تنفيذها.
2. إذا كان رمز التشغيل الذي يتم تنفيذه هو [`REVERT`](https://www.evm.codes/#fd)، فإن الحالة الجديدة هي نفسها الحالة القديمة، ويتم فقد بعض الغاز.
3. إذا انتهت سلسلة العمليات، كما هو موضح بواسطة [`RETURN`](https://www.evm.codes/#f3))، يتم تحديث الحالة إلى الحالة الجديدة.
4. إذا لم نكن في إحدى الحالات النهائية 1-3، فاستمر في التشغيل.

## 9.4.1 حالة الآلة {#941-machine-state}

يشرح هذا القسم حالة الآلة بمزيد من التفصيل. يحدد أن _w_ هو رمز التشغيل الحالي. إذا كانت _μ<sub>pc</sub>_ أقل من _||I<sub>b</sub>||_، وهو طول النص البرمجي، فإن ذلك البايت (_I<sub>b</sub>[μ<sub>pc</sub>]_) هو رمز التشغيل. وإلا، يتم تعريف رمز التشغيل على أنه [`STOP`](https://www.evm.codes/#00).

نظرًا لأن هذه [آلة مكدس](https://en.wikipedia.org/wiki/Stack_machine)، فنحن بحاجة إلى تتبع عدد العناصر التي تم إخراجها (_δ_) وإدخالها (_α_) بواسطة كل رمز تشغيل.

## 9.4.2 التوقف الاستثنائي {#942-exceptional-halt}

يحدد هذا القسم الدالة _Z_، التي تحدد متى يكون لدينا إنهاء غير طبيعي. هذه دالة [منطقية](https://en.wikipedia.org/wiki/Boolean_data_type)، لذا فهي تستخدم [_∨_ لـ أو المنطقية](https://en.wikipedia.org/wiki/Logical_disjunction) و[_∧_ لـ و المنطقية](https://en.wikipedia.org/wiki/Logical_conjunction).

يكون لدينا توقف استثنائي إذا كان أي من هذه الشروط صحيحًا:

- **_μ<sub>g</sub> < C(σ,μ,A,I)_**
  كما رأينا في القسم 9.2، _C_ هي الدالة التي تحدد تكلفة الغاز. لا يوجد غاز متبقٍ كافٍ لتغطية رمز التشغيل التالي.

- **_δ<sub>w</sub>=∅_**
  إذا كان عدد العناصر التي تم إخراجها لرمز تشغيل غير محدد، فإن رمز التشغيل نفسه غير محدد.

- **_|| μ<sub>s</sub> || < δ<sub>w</sub>_**
  تدفق سفلي للمكدس، لا توجد عناصر كافية في المكدس لرمز التشغيل الحالي.

- **_w = JUMP ∧ μ<sub>s</sub>[0]∉D(I<sub>b</sub>)_**
  رمز التشغيل هو [`JUMP`](https://www.evm.codes/#56) والعنوان ليس [`JUMPDEST`](https://www.evm.codes/#5b). القفزات صالحة _فقط_ عندما يكون الوجهة [`JUMPDEST`](https://www.evm.codes/#5b).

- **_w = JUMPI ∧ μ<sub>s</sub>[1]≠0 ∧ μ<sub>s</sub>[0] ∉ D(I<sub>b</sub>)_**
  رمز التشغيل هو [`JUMPI`](https://www.evm.codes/#57)، والشرط صحيح (غير صفري) لذا يجب أن تحدث القفزة، والعنوان ليس [`JUMPDEST`](https://www.evm.codes/#5b). القفزات صالحة _فقط_ عندما يكون الوجهة [`JUMPDEST`](https://www.evm.codes/#5b).

- **_w = RETURNDATACOPY ∧ μ<sub>s</sub>[1]+μ<sub>s</sub>[2]>|| μ<sub>o</sub> ||_**
  رمز التشغيل هو [`RETURNDATACOPY`](https://www.evm.codes/#3e). في رمز التشغيل هذا، عنصر المكدس _μ<sub>s</sub>[1]_ هو الإزاحة للقراءة منها في مخزن بيانات الإرجاع، وعنصر المكدس _μ<sub>s</sub>[2]_ هو طول البيانات. يحدث هذا الشرط عندما تحاول القراءة بعد نهاية مخزن بيانات الإرجاع. لاحظ أنه لا يوجد شرط مماثل لبيانات الاستدعاء أو للنص البرمجي نفسه. عندما تحاول القراءة بعد نهاية تلك المخازن المؤقتة، تحصل على أصفار فقط.

- **_|| μ<sub>s</sub> || - δ<sub>w</sub> + α<sub>w</sub> > 1024_**

  تجاوز المكدس. إذا أدى تشغيل رمز التشغيل إلى مكدس يزيد عن 1024 عنصرًا، فقم بالإجهاض.

- **_¬I<sub>w</sub> ∧ W(w,μ)_**
  هل نعمل بشكل ثابت ([¬ هو النفي](https://en.wikipedia.org/wiki/Negation) و_I<sub>w</sub>_ صحيح عندما يُسمح لنا بتغيير حالة البلوك تشين)؟ إذا كان الأمر كذلك، ونحن نحاول إجراء عملية تغيير الحالة، فلا يمكن أن يحدث ذلك.

  الدالة _W(w,μ)_ معرَّفة لاحقًا في المعادلة 150. _W(w,μ)_ صحيح إذا كان أحد هذه الشروط صحيحًا:

  - **_w ∈ \{CREATE, CREATE2, SSTORE, SELFDESTRUCT}_**
    تغير رموز التشغيل هذه الحالة، إما عن طريق إنشاء عقد جديد، أو تخزين قيمة، أو تدمير العقد الحالي.

  - **_LOG0≤w ∧ w≤LOG4_**
    إذا تم استدعاؤنا بشكل ثابت، فلا يمكننا إصدار إدخالات السجل.
    جميع رموز تشغيل السجل موجودة في النطاق بين [`LOG0` (A0)](https://www.evm.codes/#a0) و[`LOG4` (A4)](https://www.evm.codes/#a4).
    يحدد الرقم الموجود بعد رمز تشغيل السجل عدد الموضوعات التي يحتوي عليها إدخال السجل.

  - **_w=CALL ∧ μ<sub>s</sub>[2]≠0_**
    يمكنك استدعاء عقد آخر عندما تكون ثابتًا، ولكن إذا فعلت ذلك، فلا يمكنك تحويل ETH إليه.

- **_w = SSTORE ∧ μ<sub>g</sub> ≤ G<sub>callstipend</sub>_**
  لا يمكنك تشغيل [`SSTORE`](https://www.evm.codes/#55) إلا إذا كان لديك أكثر من G<sub>callstipend</sub> (المعروف باسم 2300 في الملحق G) غاز.

## 9.4.3 صلاحية وجهة القفز {#943-jump-dest-valid}

هنا نحدد رسميًا ما هي رموز تشغيل [`JUMPDEST`](https://www.evm.codes/#5b). لا يمكننا فقط البحث عن قيمة البايت 0x5B، لأنها قد تكون داخل PUSH (وبالتالي بيانات وليست رمز تشغيل).

في المعادلة (153) نعرّف دالة _N(i,w)_. المعلمة الأولى، _i_، هي موقع رمز التشغيل. الثانية، _w_، هي رمز التشغيل نفسه. إذا كان _w∈[PUSH1, PUSH32]_، فهذا يعني أن رمز التشغيل هو PUSH (الأقواس المربعة تحدد نطاقًا يتضمن نقاط النهاية). في هذه الحالة، يكون رمز التشغيل التالي عند _i+2+(w−PUSH1)_. بالنسبة إلى [`PUSH1`](https://www.evm.codes/#60)، نحتاج إلى التقدم بمقدار اثنين من البايتات (PUSH نفسه وقيمة البايت الواحد)، بالنسبة إلى [`PUSH2`](https://www.evm.codes/#61)، نحتاج إلى التقدم بمقدار ثلاثة بايتات لأنها قيمة بايتين، إلخ. جميع رموز تشغيل آلة الإيثيريوم الافتراضية (EVM) الأخرى يبلغ طولها بايت واحد فقط، لذلك في جميع الحالات الأخرى تكون _N(i,w)=i+1_.

تُستخدم هذه الدالة في المعادلة (152) لتعريف _D<sub>J</sub>(c,i)_، وهي [مجموعة](https://en.wikipedia.org/wiki/Set_\(mathematics\)) من جميع وجهات القفز الصالحة في النص البرمجي _c_، بدءًا من موقع رمز التشغيل _i_. هذه الدالة مُعرَّفة بشكل تكراري. إذا كانت _i≥||c||_، فهذا يعني أننا في نهاية النص البرمجي أو بعده. لن نجد أي وجهات قفز أخرى، لذلك ما عليك سوى إرجاع المجموعة الفارغة.

في جميع الحالات الأخرى، ننظر إلى بقية النص البرمجي بالانتقال إلى رمز التشغيل التالي والحصول على المجموعة التي تبدأ منه. _c[i]_ هو رمز التشغيل الحالي، لذا فإن _N(i,c[i])_ هو موقع رمز التشغيل التالي. لذلك فإن _D<sub>J</sub>(c,N(i,c[i]))_ هي مجموعة وجهات القفز الصالحة التي تبدأ عند رمز التشغيل التالي. إذا لم يكن رمز التشغيل الحالي `JUMPDEST`، فما عليك سوى إرجاع تلك المجموعة. إذا كان `JUMPDEST`، فقم بتضمينه في مجموعة النتائج وأعد ذلك.

## 9.4.4 التوقف العادي {#944-normal-halt}

يمكن لدالة التوقف _H_ أن تُرجع ثلاثة أنواع من القيم.

- إذا لم نكن في رمز تشغيل للتوقف، فقم بإرجاع _∅_، المجموعة الفارغة. حسب الاصطلاح، يتم تفسير هذه القيمة على أنها خطأ منطقي.
- إذا كان لدينا رمز تشغيل للتوقف لا ينتج مخرجات (إما [`STOP`](https://www.evm.codes/#00) أو [`SELFDESTRUCT`](https://www.evm.codes/#ff))، فقم بإرجاع تسلسل من البايتات ذات الحجم الصفري كقيمة إرجاع. لاحظ أن هذا مختلف تمامًا عن المجموعة الفارغة. تعني هذه القيمة أن آلة الإيثيريوم الافتراضية (EVM) قد توقفت بالفعل، ولكن لا توجد بيانات إرجاع للقراءة.
- إذا كان لدينا رمز تشغيل للتوقف ينتج مخرجات (إما [`RETURN`](https://www.evm.codes/#f3) أو [`REVERT`](https://www.evm.codes/#fd))، فقم بإرجاع تسلسل البايتات المحدد بواسطة رمز التشغيل هذا. يتم أخذ هذا التسلسل من الذاكرة، والقيمة الموجودة في أعلى المكدس (_μ<sub>s</sub>[0]_) هي أول بايت، والقيمة التي تليها (_μ<sub>s</sub>[1]_) هي الطول.

## H.2 مجموعة التعليمات {#h2-instruction-set}

قبل أن ننتقل إلى القسم الفرعي الأخير من آلة الإيثيريوم الافتراضية (EVM)، 9.5، دعنا نلقي نظرة على التعليمات نفسها. تم تعريفها في الملحق H.2 الذي يبدأ في الصفحة 29. من المتوقع أن يظل أي شيء لم يتم تحديده على أنه يتغير مع رمز التشغيل المحدد كما هو. يتم تحديد المتغيرات التي تتغير بـ \<something\>′.

على سبيل المثال، دعنا نلقي نظرة على رمز التشغيل [`ADD`](https://www.evm.codes/#01).

| Value | الترميز المساعد | δ | α | الوصف                                                                                                                                                                                                                 |
| ----: | --------------- | - | - | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  0x01 | ADD             | 2 | ١ | عملية الجمع.                                                                                                                                                                                          |
|       |                 |   |   | _μ′<sub>s</sub>[0] ≡ μ<sub>s</sub>[0] + μ<sub>s</sub>[1]_ |

_δ_ هو عدد القيم التي نخرجها من المكدس. في هذه الحالة اثنان، لأننا نضيف القيمتين العلويتين.

_α_ هو عدد القيم التي ندفعها مرة أخرى. في هذه الحالة واحد، وهو المجموع.

لذا فإن قمة المكدس الجديدة (_μ′<sub>s</sub>[0]_) هي مجموع قمة المكدس القديمة (_μ<sub>s</sub>[0]_) والقيمة القديمة تحتها (_μ<sub>s</sub>[1]_).

بدلاً من استعراض جميع رموز التشغيل في "قائمة مملة"، يشرح هذا المقال فقط رموز التشغيل التي تقدم شيئًا جديدًا.

| Value | الترميز المساعد | δ | α | الوصف                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ----: | --------------- | - | - | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  0x20 | KECCAK256       | 2 | ١ | حساب تجزئة (هاش) Keccak-256.                                                                                                                                                                                                                                                                                                                                                                                                      |
|       |                 |   |   | _μ′<sub>s</sub>[0] ≡ KEC(μ<sub>m</sub>[μ<sub>s</sub>[0] . . . (μ<sub>s</sub>[0] + μ<sub>s</sub>[1] − 1)])_ |
|       |                 |   |   | _μ′<sub>i</sub> ≡ M(μ<sub>i</sub>,μ<sub>s</sub>[0],μ<sub>s</sub>[1])_                                                                                                                                                                                                                                                                     |

هذا هو أول رمز تشغيل يصل إلى الذاكرة (في هذه الحالة، للقراءة فقط). ومع ذلك، قد يتوسع إلى ما بعد الحدود الحالية للذاكرة، لذلك نحتاج إلى تحديث _μ<sub>i</sub>._ نقوم بذلك باستخدام الدالة _M_ المحددة في المعادلة 328 في الصفحة 29.

| Value | الترميز المساعد | δ | α | الوصف                                               |
| ----: | --------------- | - | - | --------------------------------------------------- |
|  0x31 | BALANCE         | ١ | ١ | الحصول على رصيد الحساب المحدد.      |
|       |                 |   |   | ... |

العنوان الذي نحتاج إلى إيجاد رصيده هو _μ<sub>s</sub>[0] mod 2<sup>160</sup>_. أعلى المكدس هو العنوان، ولكن نظرًا لأن العناوين تبلغ 160 بت فقط، فإننا نحسب القيمة [باقي القسمة](https://en.wikipedia.org/wiki/Modulo_operation) 2<sup>160</sup>.

إذا كانت _σ[μ<sub>s</sub>[0] mod 2<sup>160</sup>] ≠ ∅_، فهذا يعني أن هناك معلومات حول هذا العنوان. في هذه الحالة، يكون _σ[μ<sub>s</sub>[0] mod 2<sup>160</sup>]<sub>b</sub>_ هو الرصيد لهذا العنوان. إذا كانت _σ[μ<sub>s</sub>[0] mod 2<sup>160</sup>] = ∅_، فهذا يعني أن هذا العنوان غير مهيأ وأن الرصيد صفر. يمكنك رؤية قائمة حقول معلومات الحساب في القسم 4.1 في الصفحة 4.

المعادلة الثانية، _A'<sub>a</sub> ≡ A<sub>a</sub> ∪ \{μ<sub>s</sub>[0] mod 2<sup>160</sup>}_، تتعلق بالفرق في التكلفة بين الوصول إلى التخزين الدافئ (التخزين الذي تم الوصول إليه مؤخرًا ومن المحتمل أن يتم تخزينه مؤقتًا) والتخزين البارد (التخزين الذي لم يتم الوصول إليه ومن المحتمل أن يكون في تخزين أبطأ وأكثر تكلفة لاسترداده). _A<sub>a</sub>_ هي قائمة العناوين التي تم الوصول إليها مسبقًا بواسطة المعاملة، والتي يجب أن تكون بالتالي أرخص للوصول إليها، كما هو محدد في القسم 6.1 في الصفحة 8. يمكنك قراءة المزيد حول هذا الموضوع في [EIP-2929](https://eips.ethereum.org/EIPS/eip-2929).

| Value | الترميز المساعد | δ  | α  | الوصف                                                                                                                                           |
| ----: | --------------- | -- | -- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
|  0x8F | DUP16           | 16 | 17 | تكرار عنصر المكدس السادس عشر.                                                                                                   |
|       |                 |    |    | _μ′<sub>s</sub>[0] ≡ μ<sub>s</sub>[15]_ |

لاحظ أنه لاستخدام أي عنصر في المكدس، نحتاج إلى إخراجه، مما يعني أننا بحاجة أيضًا إلى إخراج جميع عناصر المكدس فوقه. في حالة [`DUP<n>`](https://www.evm.codes/#8f) و[`SWAP<n>`](https://www.evm.codes/#9f)، هذا يعني الاضطرار إلى إخراج ثم دفع ما يصل إلى ستة عشر قيمة.

## 9.5 دورة التنفيذ {#95-exec-cycle}

الآن بعد أن أصبح لدينا كل الأجزاء، يمكننا أخيرًا فهم كيفية توثيق دورة تنفيذ آلة الإيثيريوم الافتراضية (EVM).

تقول المعادلة (155) أنه بالنظر إلى الحالة:

- _σ_ (حالة البلوك تشين العالمية)
- _μ_ (حالة آلة الإيثيريوم الافتراضية)
- _A_ (الحالة الفرعية، التغييرات التي ستحدث عند انتهاء المعاملة)
- _I_ (بيئة التنفيذ)

الحالة الجديدة هي _(σ', μ', A', I')_.

تحدد المعادلات (156)-(158) المكدس والتغيير فيه بسبب رمز التشغيل (_μ<sub>s</sub>_). المعادلة (159) هي التغيير في الغاز (_μ<sub>g</sub>_). المعادلة (160) هي التغيير في عداد البرنامج (_μ<sub>pc</sub>_). أخيرًا، تحدد المعادلات (161)-(164) أن المعلمات الأخرى تظل كما هي، ما لم يتم تغييرها صراحةً بواسطة رمز التشغيل.

بهذا يتم تعريف آلة الإيثيريوم الافتراضية (EVM) بالكامل.

## الخلاصة {#conclusion}

الترميز الرياضي دقيق وقد سمح للورقة الصفراء بتحديد كل تفاصيل إيثريوم. ومع ذلك، لديها بعض العيوب:

- لا يمكن فهمها إلا من قبل البشر، مما يعني أنه يجب كتابة [اختبارات الامتثال](https://github.com/ethereum/tests) يدويًا.
- يفهم المبرمجون النص البرمجي للحاسوب.
  قد يفهمون أو لا يفهمون الترميز الرياضي.

ربما لهذه الأسباب، كُتبت [مواصفات طبقة الإجماع](https://github.com/ethereum/consensus-specs/blob/dev/tests/core/pyspec/README.md) الأحدث بلغة Python. هناك [مواصفات طبقة التنفيذ بلغة Python](https://ethereum.github.io/execution-specs)، لكنها ليست كاملة. إلى أن تتم ترجمة الورقة الصفراء بأكملها أيضًا إلى لغة Python أو لغة مشابهة، ستستمر الورقة الصفراء في الخدمة، ومن المفيد أن تكون قادرًا على قراءتها.
