---
title: "ููููุฉ ุงุณุชุฎุฏุงู Echidna ูุงุฎุชุจุงุฑ ุงูุนููุฏ ุงูุฐููุฉ"
description: "ููููุฉ ุงุณุชุฎุฏุงู Echidna ูุงุฎุชุจุงุฑ ุงูุนููุฏ ุงูุฐููุฉ ุชููุงุฆููุง"
author: "ุทุฑูู ุงูุจุชุงุช"
lang: ar
tags:
  [
    "ุงูุตูุงุจุฉ",
    "ุงูุนููุฏ ุงูุฐููู ",
    "ุงูุฃูู",
    "ุงูุงุฎุชุจุงุฑ",
    "ุงูุชุดููุด"
  ]
skill: advanced
published: 2020-04-10
source: "ุนููุฏ ุงูุจูุงุก ุงูุขููุฉ"
sourceUrl: https://github.com/crytic/building-secure-contracts/tree/master/program-analysis/echidna
---

## ุงูุชุซุจูุช {#installation}

ูููู ุชุซุจูุช Echidna ูู ุฎูุงู docker ุฃู ุจุงุณุชุฎุฏุงู ุงูููู ุงูุซูุงุฆู ุงููุชุฑุฌู ูุณุจููุง.

### Echidna ูู ุฎูุงู docker {#echidna-through-docker}

```bash
docker pull trailofbits/eth-security-toolbox
docker run -it -v "$PWD":/home/training trailofbits/eth-security-toolbox
```

_ุงูุฃูุฑ ุงูุฃุฎูุฑ ูุดุบู eth-security-toolbox ูู ุญุงููุฉ docker ูุฏููุง ุตูุงุญูุฉ ุงููุตูู ุฅูู ุฏูููู ุงูุญุงูู. ููููู ุชุบููุฑ ุงููููุงุช ูู ูุถูููุ ูุชุดุบูู ุงูุฃุฏูุงุช ุนูู ุงููููุงุช ูู ุญุงููุฉ docker_

ุฏุงุฎู dockerุ ูู ุจุชุดุบูู:

```bash
solc-select 0.5.11
cd /home/training
```

### ุซูุงุฆู {#binary}

[https://github.com/crytic/echidna/releases/tag/v1.4.0.0](https://github.com/crytic/echidna/releases/tag/v1.4.0.0)

## ููุฏูุฉ ุนู ุงูุชุดููุด ุงููุงุฆู ุนูู ุงูุฎุตุงุฆุต {#introduction-to-property-based-fuzzing}

Echidna ูู ุฃุฏุงุฉ ุชุดููุด ูุงุฆูุฉ ุนูู ุงูุฎุตุงุฆุตุ ููุง ูุตููุง ูู ููุดูุฑุงุช ูุฏููุชูุง ุงูุณุงุจูุฉ ([1](https://blog.trailofbits.com/2018/03/09/echidna-a-smart-fuzzer-for-ethereum/)ุ [2](https://blog.trailofbits.com/2018/05/03/state-machine-testing-with-echidna/)ุ [3](https://blog.trailofbits.com/2020/03/30/an-echidna-for-all-seasons/)).

### ุงูุชุดููุด {#fuzzing}

[ุงูุชุดููุด](https://wikipedia.org/wiki/Fuzzing) ูู ุฃุณููุจ ูุนุฑูู ูู ูุฌุชูุน ุงูุฃูู. ููู ูุชุฃูู ูู ุชูููุฏ ูุฏุฎูุงุช ุนุดูุงุฆูุฉ ุฅูู ุญุฏ ูุง ููุนุซูุฑ ุนูู ุงูุฃุฎุทุงุก ูู ุงูุจุฑูุงูุฌ. ุชูุนุฑู ุฃุฏูุงุช ุงูุชุดููุด ููุจุฑุงูุฌ ุงูุชูููุฏูุฉ (ูุซู [AFL](http://lcamtuf.coredump.cx/afl/) ุฃู [LibFuzzer](https://llvm.org/docs/LibFuzzer.html)) ุจุฃููุง ุฃุฏูุงุช ูุนุงูุฉ ููุนุซูุฑ ุนูู ุงูุฃุฎุทุงุก.

ุฅูู ุฌุงูุจ ุงูุชูููุฏ ุงูุนุดูุงุฆู ุงูุจุญุช ูููุฏุฎูุงุชุ ููุงู ุงูุนุฏูุฏ ูู ุงูุชูููุงุช ูุงูุงุณุชุฑุงุชูุฌูุงุช ูุชูููุฏ ูุฏุฎูุงุช ุฌูุฏุฉุ ุจูุง ูู ุฐูู:

- ุงูุญุตูู ุนูู ููุงุญุธุงุช ูู ูู ุชูููุฐ ูุชูุฌูู ุนูููุฉ ุงูุชูููุฏ ุจุงุณุชุฎุฏุงููุง. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ุฃุฏู ุฅุฏุฎุงู ุชู ุฅูุดุงุคู ุญุฏูุซูุง ุฅูู ุงูุชุดุงู ูุณุงุฑ ุฌุฏูุฏุ ููู ุงูููุทูู ุฅูุดุงุก ูุฏุฎูุงุช ุฌุฏูุฏุฉ ูุฑูุจุฉ ููู.
- ุชูููุฏ ุงููุฏุฎูุงุช ูุน ุงุญุชุฑุงู ุงููููุฏ ุงููููููุฉ. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ุฅุฏุฎุงูู ูุญุชูู ุนูู ุฑุฃุณ ุจู ูุฌููุน ุงุฎุชุจุงุฑูุ ูุณูููู ูู ุงูููุทูู ุงูุณูุงุญ ูุฃุฏุงุฉ ุงูุชุดููุด ุจุฅูุดุงุก ูุฏุฎูุงุช ููุชุญูู ูู ุตุญุฉ ุงููุฌููุน ุงูุงุฎุชุจุงุฑู.
- ุงุณุชุฎุฏุงู ุงููุฏุฎูุงุช ุงููุนุฑููุฉ ูุฅูุดุงุก ูุฏุฎูุงุช ุฌุฏูุฏุฉ: ุฅุฐุง ูุงู ูุฏูู ุญู ุงููุตูู ุฅูู ูุฌููุนุฉ ุจูุงูุงุช ูุจูุฑุฉ ูู ุงููุฏุฎูุงุช ุงูุตุงูุญุฉุ ููููู ูุฃุฏุงุฉ ุงูุชุดููุด ุงูุฎุงุตุฉ ุจู ุฅูุดุงุก ูุฏุฎูุงุช ุฌุฏูุฏุฉ ูููุงุ ุจุฏูุงู ูู ุจุฏุก ุฅูุดุงุฆูุง ูู ุงูุตูุฑ. ุชุณูู ูุฐู ุนุงุฏุฉ _seeds_.

### ุงูุชุดููุด ุงููุงุฆู ุนูู ุงูุฎุตุงุฆุต {#property-based-fuzzing}

ุชูุชูู Echidna ุฅูู ุนุงุฆูุฉ ูุนููุฉ ูู ุฃุฏูุงุช ุงูุชุดููุด: ุงูุชุดููุด ุงููุงุฆู ุนูู ุงูุฎุตุงุฆุต ุงููุณุชูุญู ุจุดูู ูุจูุฑ ูู [QuickCheck](https://wikipedia.org/wiki/QuickCheck). ุนูู ุนูุณ ุฃุฏุงุฉ ุงูุชุดููุด ุงูููุงุณูููุฉ ุงูุชู ุณุชุญุงูู ุงูุนุซูุฑ ุนูู ุฃุนุทุงูุ ุณุชุญุงูู Echidna ูุณุฑ ุงูุซูุงุจุช ุงููุญุฏุฏุฉ ูู ูุจู ุงููุณุชุฎุฏู.

ูู ุงูุนููุฏ ุงูุฐููุฉุ ุงูุซูุงุจุช ูู ูุธุงุฆู Solidityุ ูุงูุชู ูููู ุฃู ุชูุซู ุฃู ุญุงูุฉ ุบูุฑ ุตุญูุญุฉ ุฃู ุบูุฑ ุตุงูุญุฉ ูููู ุฃู ูุตู ุฅูููุง ุงูุนูุฏุ ุจูุง ูู ุฐูู:

- ุชุญูู ุบูุฑ ุตุญูุญ ูู ุงููุตูู: ุฃุตุจุญ ุงูููุงุฌู ูุงูู ุงูุนูุฏ.
- ุขูุฉ ุญุงูุฉ ุบูุฑ ุตุญูุญุฉ: ูููู ููู ุงูุฑููุฒ ุฃุซูุงุก ุฅููุงู ุงูุนูุฏ ูุคูุชูุง.
- ุนูููุฉ ุญุณุงุจูุฉ ุบูุฑ ุตุญูุญุฉ: ูููู ูููุณุชุฎุฏู ุฃู ูุชุณุจุจ ูู ุชุฏูู ุณููู ูุฑุตูุฏู ููุญุตู ุนูู ุฑููุฒ ูุฌุงููุฉ ุบูุฑ ูุญุฏูุฏุฉ.

### ุงุฎุชุจุงุฑ ุฎุงุตูุฉ ุจุงุณุชุฎุฏุงู Echidna {#testing-a-property-with-echidna}

ุณูุฑู ููููุฉ ุงุฎุชุจุงุฑ ุนูุฏ ุฐูู ุจุงุณุชุฎุฏุงู Echidna. ุงููุฏู ูู ุงูุนูุฏ ุงูุฐูู ุงูุชุงูู [`token.sol`](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/token.sol):

```solidity
contract Token{
  mapping(address => uint) public balances;
  function airdrop() public{
      balances[msg.sender] = 1000;
  }
  function consume() public{
      require(balances[msg.sender]>0);
      balances[msg.sender] -= 1;
  }
  function backdoor() public{
      balances[msg.sender] += 1;
  }
}
```

ุณููุชุฑุถ ุฃู ูุฐุง ุงูุฑูุฒ ูุฌุจ ุฃู ูุชูุชุน ุจุงูุฎุตุงุฆุต ุงูุชุงููุฉ:

- ูููู ูุฃู ุดุฎุต ุงูุชูุงู 1000 ุฑูุฒ ูุญุฏ ุฃูุตู
- ูุง ูููู ููู ุงูุฑูุฒ (ุฅูู ููุณ ุฑูุฒ ERC20)

### ูุชุงุจุฉ ุฎุงุตูุฉ {#write-a-property}

ุฎุตุงุฆุต Echidna ูู ูุธุงุฆู Solidity. ูุฌุจ ุฃู ุชุณุชููู ุงูุฎุงุตูุฉ ูุง ููู:

- ุฃูุง ุชุญุชูู ุนูู ูุณูุทุฉ
- ุฅุฑุฌุงุน `true` ุฅุฐุง ูุงูุช ูุงุฌุญุฉ
- ุฃู ูุจุฏุฃ ุงุณููุง ุจู `echidna`

ุณุชููู Echidna ุจูุง ููู:

- ุชูููุฏ ูุนุงููุงุช ุนุดูุงุฆูุฉ ุชููุงุฆููุง ูุงุฎุชุจุงุฑ ุงูุฎุงุตูุฉ.
- ุงูุฅุจูุงุบ ุนู ุฃู ูุนุงููุงุช ุชุคุฏู ุฅูู ุฅุฑุฌุงุน ุงูุฎุงุตูุฉ `false` ุฃู ุฅุทูุงู ุฎุทุฃ.
- ุชุฌุงูู ุงูุชุฃุซูุฑ ุงูุฌุงูุจู ุนูุฏ ุงุณุชุฏุนุงุก ุฎุงุตูุฉ (ุฃูุ ุฅุฐุง ุบูุฑุช ุงูุฎุงุตูุฉ ูุชุบูุฑ ุญุงูุฉุ ูุชู ุชุฌุงููู ุจุนุฏ ุงูุงุฎุชุจุงุฑ)

ุชุชุญูู ุงูุฎุงุตูุฉ ุงูุชุงููุฉ ูู ุฃู ุงููุชุตู ูุง ูููู ุฃูุซุฑ ูู 1000 ุฑูุฒ:

```solidity
function echidna_balance_under_1000() public view returns(bool){
      return balances[msg.sender] <= 1000;
}
```

ุงุณุชุฎุฏู ุงููุฑุงุซุฉ ููุตู ุนูุฏู ุนู ุฎุตุงุฆุตู:

```solidity
contract TestToken is Token{
      function echidna_balance_under_1000() public view returns(bool){
            return balances[msg.sender] <= 1000;
      }
  }
```

[`token.sol`](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/token.sol) ูููุฐ ุงูุฎุงุตูุฉ ููุฑุซ ูู ุงูุฑูุฒ.

### ุชููุฆุฉ ุนูุฏ {#initiate-a-contract}

ุชุญุชุงุฌ Echidna ุฅูู [ุฏุงูุฉ ุจูุงุก](/developers/docs/smart-contracts/anatomy/#constructor-functions) ุจุฏูู ูุณูุทุฉ. ุฅุฐุง ูุงู ุนูุฏู ุจุญุงุฌุฉ ุฅูู ุชููุฆุฉ ูุนููุฉุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู ุงูููุงู ุจุฐูู ูู ุฏุงูุฉ ุงูุจูุงุก.

ููุงู ุจุนุถ ุงูุนูุงููู ุงููุญุฏุฏุฉ ูู Echidna:

- `0x00a329c0648769A73afAc7F9381E08FB43dBEA72` ุงูุฐู ูุณุชุฏุนู ุฏุงูุฉ ุงูุจูุงุก.
- `0x10000` ู `0x20000` ู `0x00a329C0648769a73afAC7F9381e08fb43DBEA70` ุงูุชู ุชุณุชุฏุนู ุงููุธุงุฆู ุงูุฃุฎุฑู ุจุดูู ุนุดูุงุฆู.

ูุง ูุญุชุงุฌ ุฅูู ุฃู ุชููุฆุฉ ุฎุงุตุฉ ูู ูุซุงููุง ุงูุญุงููุ ููุชูุฌุฉ ูุฐูู ูุฅู ุฏุงูุฉ ุงูุจูุงุก ุงูุฎุงุตุฉ ุจูุง ูุงุฑุบุฉ.

### ุชุดุบูู Echidna {#run-echidna}

ูุชู ุชุดุบูู Echidna ุจุงุณุชุฎุฏุงู:

```bash
echidna-test contract.sol
```

ุฅุฐุง ูุงู contract.sol ูุญุชูู ุนูู ุนููุฏ ูุชุนุฏุฏุฉุ ููููู ุชุญุฏูุฏ ุงููุฏู:

```bash
echidna-test contract.sol --contract MyContract
```

### ููุฎุต: ุงุฎุชุจุงุฑ ุฎุงุตูุฉ {#summary-testing-a-property}

ููุฎุต ูุง ููู ุชุดุบูู echidna ุนูู ูุซุงููุง:

```solidity
contract TestToken is Token{
    constructor() public {}
        function echidna_balance_under_1000() public view returns(bool){
          return balances[msg.sender] <= 1000;
        }
  }
```

```bash
echidna-test testtoken.sol --contract TestToken
...

echidna_balance_under_1000: ูุดูุช!๐ฅ
  ุชุณูุณู ุงูุงุณุชุฏุนุงุกุ ุงูุชูููุต (1205/5000):
    airdrop()
    backdoor()

...
```

ูุฌุฏุช Echidna ุฃู ุงูุฎุงุตูุฉ ุชููุชูู ุฅุฐุง ุชู ุงุณุชุฏุนุงุก `backdoor`.

## ุชุตููุฉ ุงููุธุงุฆู ุงูุชู ุณูุชู ุงุณุชุฏุนุงุคูุง ุฃุซูุงุก ุญููุฉ ุงูุชุดููุด {#filtering-functions-to-call-during-a-fuzzing-campaign}

ุณูุฑู ููููุฉ ุชุตููุฉ ุงููุธุงุฆู ุงูุชู ุณูุชู ุชุดููุดูุง.
ุงููุฏู ูู ุงูุนูุฏ ุงูุฐูู ุงูุชุงูู:

```solidity
contract C {
  bool state1 = false;
  bool state2 = false;
  bool state3 = false;
  bool state4 = false;

  function f(uint x) public {
    require(x == 12);
    state1 = true;
  }

  function g(uint x) public {
    require(state1);
    require(x == 8);
    state2 = true;
  }

  function h(uint x) public {
    require(state2);
    require(x == 42);
    state3 = true;
  }

 function i() public {
    require(state3);
    state4 = true;
  }

  function reset1() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function reset2() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function echidna_state4() public returns (bool) {
    return (!state4);
  }
}
```

ูุฌุจุฑ ูุฐุง ุงููุซุงู ุงูุตุบูุฑ Echidna ุนูู ุงูุนุซูุฑ ุนูู ุชุณูุณู ูุนูู ูู ุงููุนุงููุงุช ูุชุบููุฑ ูุชุบูุฑ ุงูุญุงูุฉ.
ูุฐุง ุตุนุจ ุนูู ุฃุฏุงุฉ ุงูุชุดููุด (ููุตู ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุชูููุฐ ุฑูุฒู ูุซู [Manticore](https://github.com/trailofbits/manticore)).
ูููููุง ุชุดุบูู Echidna ููุชุญูู ูู ูุฐุง:

```bash
echidna-test multi.sol
...
echidna_state4: ูุฌุญุช! ๐
Seed: -3684648582249875403
```

### ุชุตููุฉ ุงููุธุงุฆู {#filtering-functions}

ุชูุงุฌู Echidna ุตุนูุจุฉ ูู ุงูุนุซูุฑ ุนูู ุงูุชุณูุณู ุงูุตุญูุญ ูุงุฎุชุจุงุฑ ูุฐุง ุงูุนูุฏ ูุฃู ูุธููุชู ุฅุนุงุฏุฉ ุงูุถุจุท (`reset1` ู `reset2`) ุณุชุนููุงู ุฌููุน ูุชุบูุฑุงุช ุงูุญุงูุฉ ุนูู `false`.
ููุน ุฐููุ ูููููุง ุงุณุชุฎุฏุงู ููุฒุฉ Echidna ุฎุงุตุฉ ุฅูุง ููุถุน ูุธููุฉ ุฅุนุงุฏุฉ ุงูุถุจุท ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก ุฃู ููุถุน ูุธุงุฆู `f` ู `g` ู
`h` ู `i` ููุท ูู ุงููุงุฆูุฉ ุงูุจูุถุงุก.

ููุถุน ุงููุธุงุฆู ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุกุ ูููููุง ุงุณุชุฎุฏุงู ููู ุงูุชูููู ูุฐุง:

```yaml
filterBlacklist: true
filterFunctions: ["reset1", "reset2"]
```

ููุงู ุทุฑููุฉ ุฃุฎุฑู ูุชุตููุฉ ุงููุธุงุฆู ููู ุณุฑุฏ ุงููุธุงุฆู ุงููุฏุฑุฌุฉ ูู ุงููุงุฆูุฉ ุงูุจูุถุงุก. ููููุงู ุจุฐููุ ูููููุง ุงุณุชุฎุฏุงู ููู ุงูุชูููู ูุฐุง:

```yaml
filterBlacklist: false
filterFunctions: ["f", "g", "h", "i"]
```

- `filterBlacklist` ูู `true` ุจุดูู ุงูุชุฑุงุถู.
- ุณูุชู ุฅุฌุฑุงุก ุงูุชุตููุฉ ุจุงูุงุณู ููุท (ุจุฏูู ูุนููุงุช). ุฅุฐุง ูุงู ูุฏูู `f()` ู `f(uint256)`ุ ูุฅู ุงููุฑุดุญ `"f"` ุณูุทุงุจู ููุชุง ุงููุธููุชูู.

### ุชุดุบูู Echidna {#run-echidna-1}

ูุชุดุบูู Echidna ุจุงุณุชุฎุฏุงู ููู ุชูููู `blacklist.yaml`:

```bash
echidna-test multi.sol --config blacklist.yaml
...
echidna_state4: ูุดูุช!๐ฅ
  ุชุณูุณู ุงูุงุณุชุฏุนุงุก:
    f(12)
    g(8)
    h(42)
    i()
```

ุณุชุฌุฏ Echidna ุชุณูุณู ุงููุนุงููุงุช ูุชูุฐูุจ ุงูุฎุงุตูุฉ ุนูู ุงูููุฑ ุชูุฑูุจูุง.

### ููุฎุต: ุชุตููุฉ ุงููุธุงุฆู {#summary-filtering-functions}

ูููู ูู Echidna ุฅูุง ูุถุน ูุธุงุฆู ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก ุฃู ูู ุงููุงุฆูุฉ ุงูุจูุถุงุก ูุงุณุชุฏุนุงุฆูุง ุฃุซูุงุก ุญููุฉ ุงูุชุดููุด ุจุงุณุชุฎุฏุงู:

```yaml
filterBlacklist: true
filterFunctions: ["f1", "f2", "f3"]
```

```bash
echidna-test contract.sol --config config.yaml
...
```

ุชุจุฏุฃ Echidna ุญููุฉ ุชุดููุด ุฅูุง ุจูุถุน `f1` ู `f2` ู `f3` ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก ุฃู ุจุงุณุชุฏุนุงุก ูุฐู ุงููุธุงุฆู ููุทุ ููููุง ููููุฉ `filterBlacklist` ุงูููุทููุฉ.

## ููููุฉ ุงุฎุชุจุงุฑ ุชุฃููุฏ Solidity ุจุงุณุชุฎุฏุงู Echidna {#how-to-test-soliditys-assert-with-echidna}

ูู ูุฐุง ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุงููุตูุฑุ ุณููุถุญ ููููุฉ ุงุณุชุฎุฏุงู Echidna ูุงุฎุชุจุงุฑ ูุญุต ุงูุชุฃููุฏ ูู ุงูุนููุฏ. ูููุชุฑุถ ุฃู ูุฏููุง ุนูุฏูุง ูุซู ูุฐุง:

```solidity
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    // tmp ุฃุตุบุฑ ูู ุฃู ูุณุงูู counter
    return (counter - tmp);
  }
}
```

### ูุชุงุจุฉ ุชุฃููุฏ {#write-an-assertion}

ูุฑูุฏ ุงูุชุฃูุฏ ูู ุฃู `tmp` ุฃูู ูู ุฃู ูุณุงูู `counter` ุจุนุฏ ุฅุฑุฌุงุน ุงููุฑู ุจููููุง. ูููููุง ูุชุงุจุฉ ุฎุงุตูุฉ
Echidnaุ ููููุง ุณูุญุชุงุฌ ุฅูู ุชุฎุฒูู ูููุฉ `tmp` ูู ููุงู ูุง. ุจุฏูุงู ูู ุฐููุ ูููููุง ุงุณุชุฎุฏุงู ุชุฃููุฏ ูุซู ูุฐุง:

```solidity
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp <= counter);
    return (counter - tmp);
  }
}
```

### ุชุดุบูู Echidna {#run-echidna-2}

ูุชูููู ุงุฎุชุจุงุฑ ูุดู ุงูุชุฃููุฏุ ูู ุจุฅูุดุงุก [ููู ุชูููู Echidna](https://github.com/crytic/echidna/wiki/Config) `config.yaml`:

```yaml
checkAsserts: true
```

ุนูุฏูุง ูููู ุจุชุดุบูู ูุฐุง ุงูุนูุฏ ูู Echidnaุ ูุญุตู ุนูู ุงููุชุงุฆุฌ ุงููุชููุนุฉ:

```bash
echidna-test assert.sol --config config.yaml
Analyzing contract: assert.sol:Incrementor
assertion in inc: ูุดู!๐ฅ
  ุชุณูุณู ุงูุงุณุชุฏุนุงุกุ ุงูุชูููุต (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
```

ููุง ุชุฑูุ ุชุจูุบ Echidna ุนู ุจุนุถ ุญุงูุงุช ูุดู ุงูุชุฃููุฏ ูู ูุธููุฉ `inc`. ุฅุถุงูุฉ ุฃูุซุฑ ูู ุชุฃููุฏ ูุงุญุฏ ููู ูุธููุฉ ุฃูุฑ ููููุ ููู Echidna ูุง ุชุณุชุทูุน ุชุญุฏูุฏ ุฃู ุชุฃููุฏ ูุดู.

### ูุชู ูููู ุชุณุชุฎุฏู ุงูุชุฃููุฏุงุช {#when-and-how-use-assertions}

ูููู ุงุณุชุฎุฏุงู ุงูุชุฃููุฏุงุช ูุจุฏุงุฆู ููุฎุตุงุฆุต ุงูุตุฑูุญุฉุ ุฎุงุตุฉ ุฅุฐุง ูุงูุช ุงูุดุฑูุท ุงููุฑุงุฏ ุงูุชุญูู ูููุง ูุฑุชุจุทุฉ ูุจุงุดุฑุฉ ุจุงูุงุณุชุฎุฏุงู ุงูุตุญูุญ ูุจุนุถ ุงูุนูููุงุช `f`. ุณุชุคุฏู ุฅุถุงูุฉ ุงูุชุฃููุฏุงุช ุจุนุฏ ุจุนุถ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุฅูู ูุฑุถ ุญุฏูุซ ุงููุญุต ููุฑ ุชูููุฐู:

```solidity
function f(..) public {
    // ุจุนุถ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุนูุฏุฉ
    ...
    assert (condition);
    ...
}

```

ุนูู ุงูุนูุณ ูู ุฐููุ ุณูุคุฏู ุงุณุชุฎุฏุงู ุฎุงุตูุฉ echidna ุตุฑูุญุฉ ุฅูู ุชูููุฐ ูุนุงููุงุช ุนุดูุงุฆูุฉ ููุง ุชูุฌุฏ ุทุฑููุฉ ุณููุฉ ููุฑุถ ููุช ุงูุชุญูู ูููุง ุจุงูุถุจุท. ูุง ูุฒุงู ูู ุงููููู ุงูููุงู ุจูุฐุง ุงูุญู ุงูุจุฏูู:

```solidity
function echidna_assert_after_f() public returns (bool) {
    f(..);
    return(condition);
}
```

ููุน ุฐููุ ููุงู ุจุนุถ ุงููุดุงูู:

- ููุดู ุฅุฐุง ุชู ุงูุฅุนูุงู ุนู `f` ุนูู ุฃููุง `internal` ุฃู `external`.
- ูู ุบูุฑ ุงููุงุถุญ ูุง ูู ุงููุณูุทุงุช ุงูุชู ูุฌุจ ุงุณุชุฎุฏุงููุง ูุงุณุชุฏุนุงุก `f`.
- ุฅุฐุง ุชู ุนูุณ `f`ุ ูุณุชูุดู ุงูุฎุงุตูุฉ.

ุจุดูู ุนุงูุ ููุตู ุจุงุชุจุงุน [ุชูุตูุฉ ุฌูู ุฑูุฌูุฑ](https://blog.regehr.org/archives/1091) ุญูู ููููุฉ ุงุณุชุฎุฏุงู ุงูุชุฃููุฏุงุช:

- ูุง ุชูุฑุถ ุฃู ุชุฃุซูุฑ ุฌุงูุจู ุฃุซูุงุก ูุญุต ุงูุชุฃููุฏ. ุนูู ุณุจูู ุงููุซุงู: `assert(ChangeStateAndReturn() == 1)`
- ูุง ุชุคูุฏ ุงูุนุจุงุฑุงุช ุงููุงุถุญุฉ. ุนูู ุณุจูู ุงููุซุงู `assert(var >= 0)` ุญูุซ ูุชู ุงูุฅุนูุงู ุนู `var` ูู `uint`.

ุฃุฎูุฑูุงุ ูุฑุฌู **ุนุฏู ุงุณุชุฎุฏุงู** `require` ุจุฏูุงู ูู `assert`ุ ูุฃู Echidna ูู ุชุชููู ูู ุงูุชุดุงูู (ููู ุงูุนูุฏ ุณูุนูุฏ ุนูู ุฃู ุญุงู).

### ููุฎุต: ูุญุต ุงูุชุฃููุฏ {#summary-assertion-checking}

ููุฎุต ูุง ููู ุชุดุบูู echidna ุนูู ูุซุงููุง:

```solidity
contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp <= counter);
    return (counter - tmp);
  }
}
```

```bash
echidna-test assert.sol --config config.yaml
Analyzing contract: assert.sol:Incrementor
assertion in inc: ูุดู!๐ฅ
  ุชุณูุณู ุงูุงุณุชุฏุนุงุกุ ุงูุชูููุต (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
```

ูุฌุฏุช Echidna ุฃู ุงูุชุฃููุฏ ูู `inc` ูููู ุฃู ููุดู ุฅุฐุง ุชู ุงุณุชุฏุนุงุก ูุฐู ุงููุธููุฉ ุนุฏุฉ ูุฑุงุช ุจูุณูุทุงุช ูุจูุฑุฉ.

## ุฌูุน ูุชุนุฏูู ูุฌููุนุฉ ุจูุงูุงุช Echidna {#collecting-and-modifying-an-echidna-corpus}

ุณูุฑู ููููุฉ ุฌูุน ูุงุณุชุฎุฏุงู ูุฌููุนุฉ ุจูุงูุงุช ูู ุงููุนุงููุงุช ูุน Echidna. ุงููุฏู ูู ุงูุนูุฏ ุงูุฐูู ุงูุชุงูู [`magic.sol`](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/example/magic.sol):

```solidity
contract C {
  bool value_found = false;
  function magic(uint magic_1, uint magic_2, uint magic_3, uint magic_4) public {
    require(magic_1 == 42);
    require(magic_2 == 129);
    require(magic_3 == magic_4+333);
    value_found = true;
    return;
  }

  function echidna_magic_values() public returns (bool) {
    return !value_found;
  }

}
```

ูุฌุจุฑ ูุฐุง ุงููุซุงู ุงูุตุบูุฑ Echidna ุนูู ุงูุนุซูุฑ ุนูู ููู ูุนููุฉ ูุชุบููุฑ ูุชุบูุฑ ุงูุญุงูุฉ. ูุฐุง ุตุนุจ ุนูู ุฃุฏุงุฉ ุงูุชุดููุด
(ููุตู ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุชูููุฐ ุฑูุฒู ูุซู [Manticore](https://github.com/trailofbits/manticore)).
ูููููุง ุชุดุบูู Echidna ููุชุญูู ูู ูุฐุง:

```bash
echidna-test magic.sol
...

echidna_magic_values: ูุฌุญุช! ๐

Seed: 2221503356319272685
```

ููุน ุฐููุ ูุง ูุฒุงู ุจุฅููุงููุง ุงุณุชุฎุฏุงู Echidna ูุฌูุน ูุฌููุนุฉ ุจูุงูุงุช ุนูุฏ ุชุดุบูู ุญููุฉ ุงูุชุดููุด ูุฐู.

### ุฌูุน ูุฌููุนุฉ ุจูุงูุงุช {#collecting-a-corpus}

ูุชูููู ุฌูุน ูุฌููุนุฉ ุงูุจูุงูุงุชุ ูู ุจุฅูุดุงุก ุฏููู ูุฌููุนุฉ ุงูุจูุงูุงุช:

```bash
mkdir corpus-magic
```

ูููู ุชูููู Echidna [Echidna configuration file](https://github.com/crytic/echidna/wiki/Config) `config.yaml`:

```yaml
coverage: true
corpusDir: "corpus-magic"
```

ุงูุขู ูููููุง ุชุดุบูู ุฃุฏุงุชูุง ูุงูุชุญูู ูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุฌูุนูุง:

```bash
echidna-test magic.sol --config config.yaml
```

ูุง ุชุฒุงู Echidna ุบูุฑ ูุงุฏุฑุฉ ุนูู ุงูุนุซูุฑ ุนูู ุงูููู ุงูุณุญุฑูุฉ ุงูุตุญูุญุฉุ ูููู ูููููุง ุฅููุงุก ูุธุฑุฉ ุนูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุชู ุฌูุนุชูุง.
ุนูู ุณุจูู ุงููุซุงูุ ูุงู ุฃุญุฏ ูุฐู ุงููููุงุช:

```json
[
  {
    "_gas'": "0xffffffff",
    "_delay": ["0x13647", "0xccf6"],
    "_src": "00a329c0648769a73afac7f9381e08fb43dbea70",
    "_dst": "00a329c0648769a73afac7f9381e08fb43dbea72",
    "_value": "0x0",
    "_call": {
      "tag": "SolCall",
      "contents": [
        "magic",
        [
          {
            "contents": [
              256,
              "93723985220345906694500679277863898678726808528711107336895287282192244575836"
            ],
            "tag": "AbiUInt"
          },
          {
            "contents": [256, "334"],
            "tag": "AbiUInt"
          },
          {
            "contents": [
              256,
              "68093943901352437066264791224433559271778087297543421781073458233697135179558"
            ],
            "tag": "AbiUInt"
          },
          {
            "tag": "AbiUInt",
            "contents": [256, "332"]
          }
        ]
      ]
    },
    "_gasprice'": "0xa904461f1"
  }
]
```

ูู ุงููุงุถุญ ุฃู ูุฐุง ุงูุฅุฏุฎุงู ูู ูุคุฏู ุฅูู ูุดู ุฎุงุตูุชูุง. ููุน ุฐููุ ูู ุงูุฎุทูุฉ ุงูุชุงููุฉุ ุณูุฑู ููููุฉ ุชุนุฏููู ูุฐูู.

### ุชูููู ูุฌููุนุฉ ุจูุงูุงุช {#seeding-a-corpus}

ุชุญุชุงุฌ Echidna ุฅูู ุจุนุถ ุงููุณุงุนุฏุฉ ููุชุนุงูู ูุน ูุธููุฉ `magic`. ุณูููู ุจูุณุฎ ูุชุนุฏูู ุงููุฏุฎูุงุช ูุงุณุชุฎุฏุงู ูุนููุงุช ููุงุณุจุฉ
ููุง:

```bash
cp corpus/2712688662897926208.txt corpus/new.txt
```

ุณูููู ุจุชุนุฏูู `new.txt` ูุงุณุชุฏุนุงุก `magic(42,129,333,0)`. ุงูุขูุ ูููููุง ุฅุนุงุฏุฉ ุชุดุบูู Echidna:

```bash
echidna-test magic.sol --config config.yaml
...
echidna_magic_values: ูุดูุช!๐ฅ
  ุชุณูุณู ุงูุงุณุชุฏุนุงุก:
    magic(42,129,333,0)


Unique instructions: 142
Unique codehashes: 1
Seed: -7293830866560616537

```

ูุฐู ุงููุฑุฉุ ูุฌุฏุช ุฃู ุงูุฎุงุตูุฉ ูุฏ ุงูุชููุช ุนูู ุงูููุฑ.

## ุงูุนุซูุฑ ุนูู ุงููุนุงููุงุช ุฐุงุช ุงูุงุณุชููุงู ุงูุนุงูู ููุบุงุฒ {#finding-transactions-with-high-gas-consumption}

ุณูุฑู ููููุฉ ุงูุนุซูุฑ ุนูู ุงููุนุงููุงุช ุฐุงุช ุงูุงุณุชููุงู ุงูุนุงูู ููุบุงุฒ ุจุงุณุชุฎุฏุงู Echidna. ุงููุฏู ูู ุงูุนูุฏ ุงูุฐูู ุงูุชุงูู:

```solidity
contract C {
  uint state;

  function expensive(uint8 times) internal {
    for(uint8 i=0; i < times; i++)
      state = state + i;
  }

  function f(uint x, uint y, uint8 times) public {
    if (x == 42 && y == 123)
      expensive(times);
    else
      state = 0;
  }

  function echidna_test() public returns (bool) {
    return true;
  }

}
```

ููุง ูููู ุฃู ูููู ูู `expensive` ุงุณุชููุงู ูุจูุฑ ููุบุงุฒ.

ุญุงูููุงุ ุชุญุชุงุฌ Echidna ุฏุงุฆููุง ุฅูู ุฎุงุตูุฉ ูุงุฎุชุจุงุฑูุง: ููุง `echidna_test` ุชูุฑุฌุน ุฏุงุฆููุง `true`.
ูููููุง ุชุดุบูู Echidna ููุชุญูู ูู ูุฐุง:

```
echidna-test gas.sol
...
echidna_test: ูุฌุญุช! ๐

Seed: 2320549945714142710
```

### ููุงุณ ุงุณุชููุงู ุงูุบุงุฒ {#measuring-gas-consumption}

ูุชูููู ุงุณุชููุงู ุงูุบุงุฒ ูุน Echidnaุ ูู ุจุฅูุดุงุก ููู ุชูููู `config.yaml`:

```yaml
estimateGas: true
```

ูู ูุฐุง ุงููุซุงูุ ุณูููู ุฃูุถูุง ุจุชูููู ุญุฌู ุชุณูุณู ุงููุนุงููุงุช ูุฌุนู ุงููุชุงุฆุฌ ุฃุณูู ูู ุงูููู:

```yaml
seqLen: 2
estimateGas: true
```

### ุชุดุบูู Echidna {#run-echidna-3}

ุจูุฌุฑุฏ ุฅูุดุงุก ููู ุงูุชููููุ ูููููุง ุชุดุบูู Echidna ุนูู ูุฐุง ุงููุญู:

```bash
echidna-test gas.sol --config config.yaml
...
echidna_test: ูุฌุญุช! ๐

f ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 1333608
  ุชุณูุณู ุงูุงุณุชุฏุนุงุก:
    f(42,123,249) ุณุนุฑ ุงูุบุงุฒ: 0x10d5733f0a ุชุฃุฎูุฑ ุฒููู: 0x495e5 ุชุฃุฎูุฑ ุงููุชูุฉ: 0x88b2

Unique instructions: 157
Unique codehashes: 1
Seed: -325611019680165325

```

- ุงูุบุงุฒ ุงูููุถุญ ูู ุชูุฏูุฑ ููุฏู ูู [HEVM](https://github.com/dapphub/dapptools/tree/master/src/hevm#hevm-).

### ุชุตููุฉ ุงุณุชุฏุนุงุกุงุช ุฎูุถ ุงูุบุงุฒ {#filtering-out-gas-reducing-calls}

ููุถุญ ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุญูู **ุชุตููุฉ ุงููุธุงุฆู ุงูุชู ุณูุชู ุงุณุชุฏุนุงุคูุง ุฃุซูุงุก ุญููุฉ ุงูุชุดููุด** ุฃุนูุงู ููููุฉ ุฅุฒุงูุฉ ุจุนุถ ุงููุธุงุฆู ูู ุงุฎุชุจุงุฑู.  
ูุฏ ูููู ูุฐุง ุฃูุฑูุง ุจุงูุบ ุงูุฃูููุฉ ููุญุตูู ุนูู ุชูุฏูุฑ ุฏููู ููุบุงุฒ.
ุฎุฐ ุงููุซุงู ุงูุชุงูู:

```solidity
contract C {
  address [] addrs;
  function push(address a) public {
    addrs.push(a);
  }
  function pop() public {
    addrs.pop();
  }
  function clear() public{
    addrs.length = 0;
  }
  function check() public{
    for(uint256 i = 0; i < addrs.length; i++)
      for(uint256 j = i+1; j < addrs.length; j++)
        if (addrs[i] == addrs[j])
          addrs[j] = address(0x0);
  }
  function echidna_test() public returns (bool) {
      return true;
  }
}
```

ุฅุฐุง ุชูููุช Echidna ูู ุงุณุชุฏุนุงุก ุฌููุน ุงููุธุงุฆูุ ููู ุชุฌุฏ ุจุณูููุฉ ุงููุนุงููุงุช ุฐุงุช ุชูููุฉ ุงูุบุงุฒ ุงููุฑุชูุนุฉ:

```
echidna-test pushpop.sol --config config.yaml
...
pop ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 10746
...
check ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 23730
...
clear ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 35916
...
push ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 40839
```

ุฐูู ูุฃู ุงูุชูููุฉ ุชุนุชูุฏ ุนูู ุญุฌู `addrs` ูุชููู ุงูุงุณุชุฏุนุงุกุงุช ุงูุนุดูุงุฆูุฉ ุฅูู ุชุฑู ุงููุตูููุฉ ูุงุฑุบุฉ ุชูุฑูุจูุง.
ููุน ุฐููุ ูุฅู ูุถุน `pop` ู `clear` ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก ูุนุทููุง ูุชุงุฆุฌ ุฃูุถู ุจูุซูุฑ:

```yaml
filterBlacklist: true
filterFunctions: ["pop", "clear"]
```

```
echidna-test pushpop.sol --config config.yaml
...
push ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 40839
...
check ุงุณุชุฎุฏูุช ุญุฏูุง ุฃูุตู ูู ุงูุบุงุฒ ูุจูุบ 1484472
```

### ููุฎุต: ุงูุนุซูุฑ ุนูู ุงููุนุงููุงุช ุฐุงุช ุงูุงุณุชููุงู ุงูุนุงูู ููุบุงุฒ {#summary-finding-transactions-with-high-gas-consumption}

ูููู ูู Echidna ุงูุนุซูุฑ ุนูู ูุนุงููุงุช ุฐุงุช ุงุณุชููุงู ุนุงูู ููุบุงุฒ ุจุงุณุชุฎุฏุงู ุฎูุงุฑ ุงูุชูููู `estimateGas`:

```yaml
estimateGas: true
```

```bash
echidna-test contract.sol --config config.yaml
...
```

ุณุชุจูุบ Echidna ุนู ุชุณูุณู ุจุฃูุตู ุงุณุชููุงู ููุบุงุฒ ููู ูุธููุฉุ ุจูุฌุฑุฏ ุงูุชูุงุก ุญููุฉ ุงูุชุดููุด.
