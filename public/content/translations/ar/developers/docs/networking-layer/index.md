---
title: "طبقة"
description: "مقدمة عن طبقات شبكة إثيريوم."
lang: ar
sidebarDepth: 2
---

إثيريوم هو شبكة النِّدّ للنِّدّ مع وجود آلاف من العقد التي يجب أن تكون قادرة على التواصل مع بعضها البعض مستخدمة بروتوكولات موحدة. طبقات الشبكة هي مجموعة من البروتوكولات التي تسمح لهذه العقد بإجاد بعضها البعض و تبادل المعلومات. و هذا يتضمن نقل المعلومات بشكل القيل و القال أو الثرثرة (تواصل واحد لمجموعة) بواسطة الشبكة كما يتم تبادل الطلبات و الإجابات بين عقد خاصة (تواصل واحد لواحد). كل عقدة يجب أن تلتزم بقواعد محددة للشبكة للتأكد بأنهم يرسلون و يستقبلون المعلومات الصحيحة.

يتكون برنامج العميل من جزأين (عملاء التنفيذ وعملاء الإجماع)، ولكل منهما مجموعة شبكات خاصة به. و كذلك التواصل مع عقد أُخرى على الإثيريوم ،عملاء التنفيذ و الإجماع عليهم التواصل مع بعضهم البعض. هذه الصفحة تعطي مقدمة إيضاحية عن البروتوكولات التي تمكن من هذا التواصل.

يقوم عملاء التنفيذ بنشر المعاملات عبر شبكة نظير إلى نظير لطبقة التنفيذ. يتطلب هذا اتصالاً مشفرًا بين النظراء المعتمدين. عندما يتم اختيار المحقق لاقتراح كتلة، سيتم تمرير المعاملات من مجموعة المعاملات المحلية للعقدة إلى عملاء الإجماع عبر اتصال RPC محلي، والذي سيتم تعبئته في كتل Beacon. بعد ذالك سوف يقوم عملاء الإجماع على ثرثرة أو نشر المعلومات عبر شبكة النِّدّ للنِّدّ. يتطلب هذا شبكتين p2p منفصلتين: واحدة تربط عملاء التنفيذ لثرثرة المعاملات والأخرى تربط عملاء الإجماع لثرثرة الكتل.

## المتطلبات الأساسية {#prerequisites}

ستكون بعض المعرفة بـ [عُقد وعملاء](/developers/docs/nodes-and-clients/) Ethereum مفيدة لفهم هذه الصفحة.

## طبقة التنفيذ {#execution-layer}

يتم تقسيم بروتوكولات الشبكات الخاصة بطبقة التنفيذ إلى مجموعتين:

- مجموعة الاكتشاف: مبنية على UDP وتسمح لعقدة جديدة بالعثور على نظراء للاتصال بهم

- مجموعة DevP2P: تقع أعلى TCP وتتيح للعقد تبادل المعلومات

تعمل كلتا المجموعتين بالتوازي. تعمل مجموعة الاكتشاف على تغذية المشاركين الجدد في الشبكة، كما تعمل مجموعة DevP2P على تمكين تفاعلاتهم.

### الاكتشاف {#discovery}

الاكتشاف هو عملية العثور على عقد أخرى في الشبكة. يتم تشغيل هذا باستخدام مجموعة صغيرة من عُقد التمهيد (bootnodes) (العُقد التي تكون عناوينها [مُضمنة برمجيًا](https://github.com/ethereum/go-ethereum/blob/master/params/bootnodes.go) في العميل بحيث يمكن العثور عليها على الفور وتوصيل العميل بالنظراء). لا توجد عقد التمهيد هذه إلا لتقديم عقدة جديدة لمجموعة من النظراء - وهذا هو غرضها الوحيد، ولا تشارك في مهام العميل العادية مثل مزامنة السلسلة، ويتم استخدامها فقط في المرة الأولى التي يتم فيها تشغيل العميل.

البروتوكول المستخدم للتفاعلات بين العُقدة وعُقدة التمهيد هو شكل مُعدّل من [Kademlia](https://medium.com/coinmonks/a-brief-overview-of-kademlia-and-its-use-in-various-decentralized-platforms-da08a7f72b8f) الذي يستخدم [جدول تجزئة موزع](https://en.wikipedia.org/wiki/Distributed_hash_table) لمشاركة قوائم العُقد. تحتوي كل عقدة على نسخة من هذا الجدول تحتوي على المعلومات المطلوبة للاتصال بأقرانها الأقرب. هذا "القرب" ليس جغرافيًا - يتم تحديد المسافة من خلال تشابه معرف العقدة. يتم تحديث جدول كل عقدة بشكل منتظم كميزة أمان. على سبيل المثال، في بروتوكول الاكتشاف [Discv5](https://github.com/ethereum/devp2p/tree/master/discv5)، يمكن لعُقد البروتوكول أيضًا إرسال 'إعلانات' تعرض البروتوكولات الفرعية التي يدعمها العميل، مما يسمح للنظراء بالتفاوض حول البروتوكولات التي يمكنهم استخدامها للتواصل.

يبدأ الاكتشاف بلعبة بينج بونج. تؤدي عملية PING-PONG الناجحة إلى "ربط" العقدة الجديدة بعقدة التمهيد. الرسالة الأولية التي تنبه عُقدة التمهيد إلى وجود عُقدة جديدة تدخل الشبكة هي `PING`. يتضمن `PING` هذا معلومات مُجزأة (hashed) حول العُقدة الجديدة وعُقدة التمهيد وختم زمني لانتهاء الصلاحية. تستقبل عُقدة التمهيد `PING` وتعيد `PONG` يحتوي على تجزئة (هاش) `PING`. إذا تطابقت قيم التجزئة (الهاش) لـ `PING` و`PONG`، يتم التحقق من الاتصال بين العُقدة الجديدة وعُقدة التمهيد ويقال إنهما "مرتبطتان".

بمجرد الارتباط، يمكن للعُقدة الجديدة إرسال طلب `FIND-NEIGHBOURS` إلى عُقدة التمهيد. تتضمن البيانات التي تم إرجاعها بواسطة عقدة التمهيد قائمة بالنظراء الذين يمكن للعقدة الجديدة الاتصال بهم. إذا لم تكن العُقد مرتبطة، فسيفشل طلب `FIND-NEIGHBOURS`، وبالتالي لن تتمكن العُقدة الجديدة من دخول الشبكة.

بمجرد أن تتلقى العقدة الجديدة قائمة من الجيران من عقدة التمهيد، تبدأ تبادل PING-PONG مع كل منهم. تربط عمليات PING-PONG الناجحة العقدة الجديدة بجيرانها، مما يتيح تبادل الرسائل.

```
بدء العميل --> الاتصال بعقدة التمهيد --> الارتباط بعقدة التمهيد --> البحث عن الجيران --> الارتباط بالجيران
```

تستخدم عملاء التنفيذ حاليًا بروتوكول الاكتشاف [Discv4](https://github.com/ethereum/devp2p/blob/master/discv4.md) وهناك جهد نشط للانتقال إلى بروتوكول [Discv5](https://github.com/ethereum/devp2p/tree/master/discv5).

#### ENR: سجلات عُقد الإيثريوم {#enr}

[سجل عُقدة الإيثريوم (ENR)](/developers/docs/networking-layer/network-addresses/) هو كائن يحتوي على ثلاثة عناصر أساسية: توقيع (تجزئة (هاش) لمحتويات السجل تم إنشاؤها وفقًا لنظام هوية متفق عليه)، ورقم تسلسلي يتتبع التغييرات في السجل، وقائمة عشوائية من أزواج المفتاح:القيمة. هذا تنسيق مُهيأ للمستقبل يسمح بتبادل أسهل للمعلومات التعريفية بين النظراء الجدد وهو تنسيق [عنوان الشبكة](/developers/docs/networking-layer/network-addresses) المفضل لعُقد الإيثريوم.

#### لماذا يتم بناء الاكتشاف على UDP؟ {#why-udp}

لا يدعم UDP أي فحص للأخطاء، أو إعادة إرسال الحزم الفاشلة، أو فتح وإغلاق الاتصالات بشكل ديناميكي - بدلاً من ذلك، فإنه يطلق فقط تدفقًا مستمرًا من المعلومات على هدف، بغض النظر عما إذا تم استلامها بنجاح أم لا. وتترجم هذه الوظيفة البسيطة أيضًا إلى الحد الأدنى من النفقات العامة، مما يجعل هذا النوع من الاتصال سريعًا جدًا. بالنسبة للاستكشاف، حيث تريد العقدة ببساطة الإعلان عن وجودها من أجل إنشاء اتصال رسمي مع نظيرها، يكون بروتوكول UDP كافياً. ومع ذلك، بالنسبة لبقية مجموعة الشبكات، فإن بروتوكول UDP غير مناسب للغرض. يعد تبادل المعلومات بين العقد معقدًا للغاية وبالتالي يحتاج إلى بروتوكول أكثر اكتمالاً يمكنه دعم إعادة الإرسال والتحقق من الأخطاء وما إلى ذلك. إن التكلفة الإضافية المرتبطة بـ TCP تستحق الوظيفة الإضافية. لذلك، تعمل غالبية مجموعة P2P عبر TCP.

### DevP2P {#devp2p}

DevP2P هو في حد ذاته مجموعة كاملة من البروتوكولات التي ينفذها Ethereum لإنشاء شبكة نظير إلى نظير والحفاظ عليها. بعد دخول العُقد الجديدة إلى الشبكة، تخضع تفاعلاتها للبروتوكولات الموجودة في حزمة [DevP2P](https://github.com/ethereum/devp2p). توجد جميع هذه البروتوكولات أعلى TCP وتتضمن بروتوكول نقل RLPx وبروتوكول الأسلاك والعديد من البروتوكولات الفرعية. [RLPx](https://github.com/ethereum/devp2p/blob/master/rlpx.md) هو البروتوكول الذي يحكم بدء الجلسات وتوثيقها وصيانتها بين العُقد. يقوم RLPx بتشفير الرسائل باستخدام RLP (بادئة الطول المتكرر) وهي طريقة فعالة للغاية من حيث المساحة لترميز البيانات في بنية بسيطة لإرسالها بين العقد.

تبدأ جلسة RLPx بين عقدتين بمصافحة تشفيرية أولية. يتضمن ذلك قيام العقدة بإرسال رسالة مصادقة يتم التحقق منها بعد ذلك بواسطة النظير. في حالة التحقق الناجح، يقوم النظير بإنشاء رسالة تأكيد المصادقة للعودة إلى العقدة المبدئية. إنها عملية تبادل المفاتيح التي تمكن العقد من التواصل بشكل خاص وآمن. بعد ذلك، يؤدي المصافحة التشفيرية الناجحة إلى تحفيز كلتا العقدتين لإرسال رسالة "مرحبًا" إلى بعضهما البعض "على السلك". يتم بدء بروتوكول السلك من خلال تبادل ناجح لرسائل الترحيب.

تحتوي رسائل الترحيب على:

- نسخة البروتوكول
- معرف العميل
- ميناء
- معرف العقدة
- قائمة البروتوكولات الفرعية المدعومة

هذه هي المعلومات المطلوبة للتفاعل الناجح لأنها تحدد القدرات المشتركة بين العقدتين وتقوم بتكوين الاتصال. هناك عملية تفاوض على البروتوكول الفرعي حيث تتم مقارنة قوائم البروتوكولات الفرعية التي يدعمها كل عقدة ويمكن استخدام تلك المشتركة بين العقدتين في الجَلسة.

إلى جانب رسائل الترحيب، يمكن لبروتوكول السلك أيضًا إرسال رسالة "قطع الاتصال" التي تحذر أحد الأقران من أن الاتصال سيتم إغلاقه. يتضمن بروتوكول السلك أيضًا رسائل PING وPONG التي يتم إرسالها بشكل دوري للحفاظ على جلسة مفتوحة. وبناءً على ذلك، تعمل تبادلات بروتوكول RLPx وwire على إرساء أسس الاتصال بين العقد، مما يوفر الإطار اللازم لتبادل المعلومات المفيدة وفقًا لبروتوكول فرعي محدد.

### البروتوكولات الفرعية {#sub-protocols}

#### بروتوكول الاتصال السلكي {#wire-protocol}

بمجرد اتصال النظراء وبدء جلسة RLPx، يحدد بروتوكول السلك كيفية تواصل النظراء. في البداية، حدد بروتوكول الأسلاك ثلاث مهام رئيسية: مزامنة السلسلة، وانتشار الكتل، وتبادل المعاملات. ومع ذلك، بمجرد تحول Ethereum إلى إثبات الحصة، أصبح انتشار الكتلة ومزامنة السلسلة جزءًا من طبقة الإجماع. لا يزال تبادل المعاملات في نطاق عمل عملاء التنفيذ. يشير تبادل المعاملات إلى تبادل المعاملات المعلقة بين العقد حتى يتمكن منشئو الكتل من تحديد بعضها لتضمينها في الكتلة التالية. تتوفر معلومات مفصلة حول هذه المهام [هنا](https://github.com/ethereum/devp2p/blob/master/caps/eth.md). العملاء الذين يدعمون هذه البروتوكولات الفرعية يعرضونها عبر [JSON-RPC](/developers/docs/apis/json-rpc/).

#### les (البروتوكول الفرعي الخفيف لإيثريوم) {#les}

هذا هو البروتوكول الأدنى لمزامنة العملاء الخفيفين. تقليديًا، نادرًا ما يتم استخدام هذا البروتوكول لأنه مطلوب من العقد الكاملة تقديم البيانات للعملاء الخفيفين دون الحصول على أي حافز. السلوك الافتراضي لعملاء التنفيذ هو عدم تقديم بيانات العميل الخفيفة عبر les. تتوفر مزيد من المعلومات في [مواصفات](https://github.com/ethereum/devp2p/blob/master/caps/les.md) les.

#### Snap {#snap}

[بروتوكول snap](https://github.com/ethereum/devp2p/blob/master/caps/snap.md#ethereum-snapshot-protocol-snap) هو امتداد اختياري يسمح للنظراء بتبادل لقطات للحالات الأخيرة، مما يسمح لهم بالتحقق من بيانات الحساب والتخزين دون الحاجة إلى تنزيل عُقد شجرة Merkle الوسيطة.

#### Wit (بروتوكول الشاهد) {#wit}

[بروتوكول الشاهد](https://github.com/ethereum/devp2p/blob/master/caps/wit.md#ethereum-witness-protocol-wit) هو امتداد اختياري يتيح تبادل شهادات الحالة بين النظراء، مما يساعد على مزامنة العملاء مع قمة السلسلة.

#### Whisper {#whisper}

Whisper هو بروتوكول يهدف إلى توصيل الرسائل الآمنة بين النظراء دون كتابة أي معلومات على blockchain. لقد كان جزءًا من بروتوكول DevP2P Wire ولكنه أصبح الآن قديمًا. توجد [مشاريع أخرى ذات صلة](https://wakunetwork.com/) بأهداف مماثلة.

## طبقة الإجماع {#consensus-layer}

يشارك عملاء الإجماع في شبكة نظير إلى نظير منفصلة بمواصفات مختلفة. يحتاج عملاء الإجماع إلى المشاركة في ثرثرة الكتلة حتى يتمكنوا من تلقي كتل جديدة من أقرانهم وبثها عندما يحين دورهم في اقتراح الكتلة. على غرار طبقة التنفيذ، يتطلب هذا أولاً بروتوكول اكتشاف حتى تتمكن العقدة من العثور على النظراء وإنشاء جلسات آمنة لتبادل الكتل والشهادات وما إلى ذلك.

### الاكتشاف {#consensus-discovery}

على غرار عملاء التنفيذ، يستخدم عملاء الإجماع [discv5](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#the-discovery-domain-discv5) عبر UDP للعثور على النظراء. يختلف تطبيق طبقة الإجماع لـ discv5 عن تطبيق عملاء التنفيذ فقط في أنه يتضمن محولاً يربط discv5 بحزمة [libP2P](https://libp2p.io/)، مما يلغي استخدام DevP2P. تم إيقاف جلسات RLPx الخاصة بطبقة التنفيذ لصالح مصافحة القناة الآمنة للضوضاء في libP2P.

### ENRs {#consensus-enr}

يتضمن سجل عُقدة الإيثريوم (ENR) لعُقد الإجماع المفتاح العام للعُقدة، وعنوان IP، ومنافذ UDP و TCP، وحقلين خاصين بالإجماع: حقل البت للشبكة الفرعية للشهادة ومفتاح `eth2`. يجعل الأمر السابق من الأسهل على العقد العثور على الأقران المشاركين في شبكات فرعية محددة لتبادل الإشاعات. يحتوي مفتاح `eth2` على معلومات حول إصدار انقسام الإيثريوم الذي تستخدمه العُقدة، مما يضمن اتصال النظراء بشبكة الإيثريوم الصحيحة.

### libP2P {#libp2p}

تدعم مجموعة libP2P جميع الاتصالات بعد الاكتشاف. يمكن للعملاء الاتصال والاستماع على IPv4 و/أو IPv6 كما هو محدد في ENR الخاص بهم. يمكن تقسيم البروتوكولات الموجودة على طبقة libP2P إلى مجالات gossip وreq/resp.

### Gossip {#gossip}

يتضمن مجال الشائعات جميع المعلومات التي يتعين أن تنتشر بسرعة عبر الشبكة. يتضمن ذلك كتل المنارات، والأدلة، والشهادات، والمخارج، والتقطيعات. يتم نقل هذا باستخدام libP2P gossipsub v1 ويعتمد على البيانات الوصفية المختلفة المخزنة محليًا في كل عقدة، بما في ذلك الحجم الأقصى لأحمال القيل والقال التي يجب استلامها وإرسالها. تتوفر معلومات مفصلة حول نطاق gossip [هنا](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#the-gossip-domain-gossipsub).

### الطلب والاستجابة {#request-response}

يحتوي مجال الطلب والاستجابة على بروتوكولات للعملاء الذين يطلبون معلومات محددة من أقرانهم. تتضمن الأمثلة طلب كتل Beacon محددة تتطابق مع تجزئات الجذر المحددة أو ضمن نطاق من الفتحات. يتم إرجاع الاستجابات دائمًا على هيئة بايتات مشفرة بتنسيق SSZ مضغوطة بسرعة.

## لماذا يفضل العميل المتفق عليه SSZ على RLP؟ {#ssz-vs-rlp}

SSZ تعني التسلسل البسيط. إنه يستخدم إزاحات ثابتة تجعل من السهل فك تشفير أجزاء فردية من رسالة مشفرة دون الحاجة إلى فك تشفير الهيكل بأكمله، وهو أمر مفيد للغاية لعميل الإجماع لأنه يمكنه الاستيلاء بكفاءة على قطع محددة من المعلومات من الرسائل المشفرة. كما تم تصميمه خصيصًا للتكامل مع بروتوكولات Merkle، مع مكاسب الكفاءة ذات الصلة لـ Merkleization. نظرًا لأن جميع التجزئات في طبقة الإجماع هي جذور Merkle، فإن هذا يؤدي إلى تحسن كبير. كما يضمن SSZ أيضًا تمثيلًا فريدًا للقيم.

## توصيل عملاء التنفيذ وعملاء الإجماع {#connecting-clients}

يتم تشغيل كل من عملاء الإجماع والعملاء التنفيذيين بالتوازي. يجب أن يتم توصيلهما حتى يتمكن عميل الإجماع من تقديم التعليمات إلى عميل التنفيذ، ويمكن لعميل التنفيذ تمرير حزم المعاملات إلى عميل الإجماع لتضمينها في كتل Beacon. يمكن تحقيق الاتصال بين العميلين باستخدام اتصال RPC محلي. تحدد واجهة برمجة تطبيقات تُعرف باسم ['Engine-API'](https://github.com/ethereum/execution-apis/blob/main/src/engine/common.md) التعليمات المرسلة بين العميلين. نظرًا لأن كلا العميلين يجلسان خلف هوية شبكة واحدة، فهما يشتركان في ENR (سجل عقدة Ethereum) الذي يحتوي على مفتاح منفصل لكل عميل (مفتاح eth1 ومفتاح eth2).

يظهر أدناه ملخص لتدفق التحكم، مع مجموعة الشبكات ذات الصلة بين قوسين.

### عندما لا يكون عميل الإجماع مُنتِجًا للكتل: {#when-consensus-client-is-not-block-producer}

- يتلقى عميل الإجماع كتلة عبر بروتوكول كتلة القيل والقال (إجماع p2p)
- يقوم عميل الإجماع بالتحقق المسبق من صحة الكتلة، أي يضمن وصولها من مرسل صالح مع بيانات وصفية صحيحة
- يتم إرسال المعاملات الموجودة في الكتلة إلى طبقة التنفيذ كحمولة تنفيذ (اتصال RPC محلي)
- تنفذ طبقة التنفيذ المعاملات وتتحقق من صحة الحالة في رأس الكتلة (أي تتحقق من تطابق قيم التجزئة (الهاش))
- تقوم طبقة التنفيذ بتمرير بيانات التحقق مرة أخرى إلى طبقة الإجماع، ويتم الآن اعتبار الكتلة مُتحققة من صحتها (اتصال RPC محلي)
- تضيف طبقة الإجماع كتلة إلى رأس سلسلة الكتل الخاصة بها وتشهد عليها، وتبث الإثبات عبر الشبكة (إجماع نظير إلى نظير)

### عندما يكون عميل الإجماع مُنتِجًا للكتل: {#when-consensus-client-is-block-producer}

- يتلقى عميل الإجماع إشعارًا بأنه منتج الكتلة التالي (إجماع p2p)
- تستدعي طبقة الإجماع طريقة `create block` في عميل التنفيذ (RPC المحلي)
- تصل طبقة التنفيذ إلى مجموعة ذاكرة المعاملات التي تم ملؤها بواسطة بروتوكول تبادل معلومات المعاملات (تنفيذ p2p)
- يقوم عميل التنفيذ بتجميع المعاملات في كتلة، وينفذ المعاملات ويولد تجزئة كتلة
- يقوم عميل الإجماع بالاستيلاء على المعاملات وتجزئة الكتلة من عميل التنفيذ وإضافتها إلى كتلة المنارة (RPC المحلي)
- يبث عميل الإجماع الكتلة عبر بروتوكول ثرثرة الكتلة (إجماع p2p)
- يتلقى العملاء الآخرون الكتلة المقترحة عبر بروتوكول كتلة الثرثرة ويقومون بالتحقق منها كما هو موضح أعلاه (إجماع p2p)

بمجرد التحقق من صحة الكتلة من قبل عدد كافٍ من المحققين، تتم إضافتها إلى رأس السلسلة، وتبريرها، وفي النهاية الانتهاء منها.

![](cons_client_net_layer.png)
![](exe_client_net_layer.png)

مخطط طبقة الشبكة لعملاء الإجماع والتنفيذ، من [ethresear.ch](https://ethresear.ch/t/eth1-eth2-client-relationship/7248)

## قراءة إضافية {#further-reading}

[DevP2P](https://github.com/ethereum/devp2p)
[LibP2p](https://github.com/libp2p/specs)
[مواصفات شبكة طبقة الإجماع](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#enr-structure)
[من kademlia إلى discv5](https://vac.dev/kademlia-to-discv5)
[بحث Kademlia](https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf)
[مقدمة إلى نظير-إلى-نظير (p2p) للإيثريوم](https://p2p.paris/en/talks/intro-ethereum-networking/)
[العلاقة بين eth1/eth2](http://ethresear.ch/t/eth1-eth2-client-relationship/7248)
[فيديو عن تفاصيل الدمج وعملاء eth2](https://www.youtube.com/watch?v=zNIrIninMgg)
