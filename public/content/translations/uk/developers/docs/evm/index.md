---
title: Віртуальна машина Ethereum (EVM)
description: Про Віртуальну машину Ethereum і те, як вона пов’язана зі станом, транзакціями та смарт-контрактами.
lang: uk
---

Віртуальна машина Ethereum (EVM) - це децентралізоване віртуальне середовище, яке виконує код послідовно і безпечно на всіх вузлах Ethereum. Вузли запускають EVM для виконання смарт-контрактів, використовуючи "[газ](/developers/docs/gas/)" для вимірювання обчислювальних зусиль, необхідних для [операцій](/developers/docs/evm/opcodes/), забезпечуючи ефективний розподіл ресурсів і безпеку мережі.

## Передумови {#prerequisites}

Щоб зрозуміти EVM, необхідне базове знайомство з поширеною термінологією в галузі інформатики, як-от [байти](https://wikipedia.org/wiki/Byte), [пам'ять](https://wikipedia.org/wiki/Computer_memory) та [стек](https://wikipedia.org/wiki/Stack_\(abstract_data_type\)). Також було б корисно ознайомитися з такими поняттями криптографії/блокчейну, як [хеш-функції](https://wikipedia.org/wiki/Cryptographic_hash_function) та [дерево Меркла](https://wikipedia.org/wiki/Merkle_tree).

## Від реєстру до скінченного автомату {#from-ledger-to-state-machine}

Аналогія з "розподіленою книгою обліку" часто використовується для опису блокчейнів (наприклад, Bitcoin), що роблять можливим використання децентралізованої валюти за допомогою ключових інструментів криптографії. У реєстрі ведеться облік діяльності, який повинен відповідати набору правил, які регулюють, що можна і що не можна робити щодо внесення змін до реєстру. Наприклад, адреса Bitcoin не може витратити більше одиниць Bitcoin, ніж отримала раніше. Ці правила лежать в основі всіх транзакцій Bitcoin і багатьох інших блокчейнів.

Хоча Ethereum має власну криптовалюту (етер), яка функціонує майже за тими ж інтуїтивно зрозумілими правилами, він також підтримує набагато потужнішу функцію: [смарт-контракти](/developers/docs/smart-contracts/). Щоб описати цю функцію, потрібна складніша аналогія. Замість розподіленого реєстру Ethereum є розподіленим [кінцевим автоматом](https://wikipedia.org/wiki/Finite-state_machine). Стан Ethereum — це велика структура даних, яка містить не лише всі облікові записи та баланси, а й _стан машини_, який може змінюватися від блоку до блоку відповідно до попередньо визначеного набору правил і може виконувати довільний машинний код. Правила зміни стану в блоках визначаються Віртуальною машиною Ethereum.

![Діаграма, що показує будову EVM](./evm.png)
_Діаграму адаптовано з [Ethereum EVM illustrated](https://takenobu-hs.github.io/downloads/ethereum_evm_illustrated.pdf)_

## Функція переходу стану Ethereum {#the-ethereum-state-transition-function}

Віртуальна машина Ethereum функціонує як математична функція – видає детермінований результат на основі введених даних. Тому досить корисно більш формально описати Ethereum як такий, що має **функцію переходу стану**:

```
Y(S, T)= S'
```

Маючи старий дійсний стан `(S)` та новий набір дійсних транзакцій `(T)`, функція переходу стану Ethereum `Y(S, T)` створює новий дійсний вихідний стан `S'`.

### Стан {#state}

У контексті Ethereum стан — це величезна структура даних, що називається [модифікованим деревом Меркла-Патриції](/developers/docs/data-structures-and-encoding/patricia-merkle-trie/), яка зберігає всі [облікові записи](/developers/docs/accounts/), пов’язані хешами, і зводиться до єдиного кореневого хешу, що зберігається в блокчейні.

### Транзакції {#transactions}

Транзакції — це криптографічно підписані інструкції з рахунків. Існують два типи операцій: ті, що призводять до викликів повідомлень, і ті, що призводять до створення контрактів.

Створення контракту призводить до створення нового контрактного рахунку, що містить скомпільований байт-код [смарт-контракту](/developers/docs/smart-contracts/anatomy/). Щоразу, коли інший рахунок здійснює виклик повідомлення для цього контракту, він використовує свій байткод.

## Інструкції EVM {#evm-instructions}

EVM виконується як [стекова машина](https://wikipedia.org/wiki/Stack_machine) з глибиною 1024 елементи. Кожен елемент - це 256-бітове слово, яке було вибрано для легкого використання з 256-бітовою криптографією (наприклад, хеші Keccak-256 або підписи secp256k1).

Під час виконання EVM підтримує тимчасову _пам’ять_ (у вигляді масиву байтів з адресацією по словах), яка не зберігається між транзакціями.

### Тимчасове сховище

Тимчасове сховище — це сховище «ключ-значення» для кожної транзакції, доступ до якого здійснюється за допомогою кодів операцій `TSTORE` і `TLOAD`. Воно зберігається впродовж усіх внутрішніх викликів під час однієї й тієї ж транзакції, але очищується в кінці транзакції. На відміну від пам'яті, тимчасове сховище моделюється як частина стану EVM, а не кадру виконання, проте воно не записується до глобального стану. Тимчасове сховище дозволяє ефективний за газом тимчасовий обмін станами між внутрішніми викликами під час транзакції.

### Сховище

Контракти містять дерево Меркла-Патриції _сховища_ (як масив слів з адресацією по словах), пов'язане з відповідним обліковим записом і є частиною глобального стану. Це постійне сховище відрізняється від тимчасового сховища, яке доступне лише протягом однієї транзакції і не є частиною постійного дерева сховища облікового запису.

### Коди операцій

Скомпільований байт-код смарт-контракту виконується як набір [кодів операцій](/developers/docs/evm/opcodes) EVM, які виконують стандартні стекові операції, як-от `XOR`, `AND`, `ADD`, `SUB` тощо. EVM також реалізує низку специфічних для блокчейну стекових операцій, як-от `ADDRESS`, `BALANCE`, `BLOCKHASH` тощо. Набір кодів операцій також включає `TSTORE` і `TLOAD`, які надають доступ до тимчасового сховища.

![Діаграма, що показує, де потрібен газ для операцій EVM](../gas/gas.png)
_Діаграми адаптовано з [Ethereum EVM illustrated](https://takenobu-hs.github.io/downloads/ethereum_evm_illustrated.pdf)_

## Реалізації EVM {#evm-implementations}

Усі налаштування Віртуальної машини Ethereum повинні відповідати специфікації, описаній у Довідковому журналі Ethereum.

За десятирічну історію Ethereum, EVM зазнала кількох переглядів, і існує кілька реалізацій EVM різними мовами програмування.

[Клієнти-виконавці Ethereum](/developers/docs/nodes-and-clients/#execution-clients) містять реалізацію EVM. Крім того, існує кілька автономних реалізацій, зокрема:

- [Py-EVM](https://github.com/ethereum/py-evm) - _Python_
- [evmone](https://github.com/ethereum/evmone) - _C++_
- [ethereumjs-vm](https://github.com/ethereumjs/ethereumjs-vm) - _JavaScript_
- [revm](https://github.com/bluealloy/revm) - _Rust_

## Додаткові матеріали {#further-reading}

- [Жовта книга Ethereum](https://ethereum.github.io/yellowpaper/paper.pdf)
- [Jellopaper, або KEVM: семантика EVM в K](https://jellopaper.org/)
- [Бежева книга](https://github.com/chronaeon/beigepaper)
- [Коди операцій віртуальної машини Ethereum](https://www.ethervm.io/)
- [Інтерактивний довідник з кодами операцій віртуальної машини Ethereum](https://www.evm.codes/)
- [Короткий вступ у документації Solidity](https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#index-6)
- [Mastering Ethereum - Віртуальна машина Ethereum](https://github.com/ethereumbook/ethereumbook/blob/openedition/13evm.asciidoc)

## Пов'язані теми {#related-topics}

- [Газ](/developers/docs/gas/)
