---
title: "Вивчайте основні теми Ethereum за допомогою SQL"
description: "Це керівництво допоможе читачам зрозуміти основні концепції Ethereum, включаючи транзакції, блоки та газ, шляхом запиту даних у ланцюжку за допомогою мови структурованих запитів (SQL)."
author: "Пол Апіват"
tags: [ "SQL", "Запити", "Транзакції" ]
skill: beginner
lang: uk
published: 2021-05-11
source: paulapivat.com
sourceUrl: https://paulapivat.com/post/query_ethereum/
---

Багато посібників з Ethereum орієнтовані на розробників, але бракує освітніх ресурсів для аналітиків даних або для людей, які бажають бачити дані в ланцюжку, не запускаючи клієнт або вузол.

Цей посібник допоможе читачам зрозуміти основні концепції Ethereum, включно із транзакціями, блоками та газом, шляхом надсилання запитів до даних у ланцюжку за допомогою мови структурованих запитів (SQL) через інтерфейс, наданий [Dune Analytics](https://dune.com/).

Дані в ланцюжку можуть допомогти нам зрозуміти Ethereum, мережу, а також економіку обчислювальної потужності та мають слугувати основою для розуміння проблем, з якими стикається Ethereum сьогодні (тобто зростанням цін на газ), і, що більш важливо, для обговорення рішень із масштабування.

### Транзакції {#transactions}

Шлях користувача в Ethereum починається з ініціалізації контрольованого користувачем облікового запису або сутності з балансом в ETH. Існує два типи облікових записів: контрольовані користувачем або смарт-контрактом (див. [ethereum.org](/developers/docs/accounts/)).

Будь-який обліковий запис можна переглянути в оглядачі блоків, наприклад [Etherscan](https://etherscan.io/) або [Blockscout](https://eth.blockscout.com/). Оглядачі блоків — це портал до даних Ethereum. Вони відображають у режимі реального часу дані про блоки, транзакції, майнерів, облікові записи та іншу активність у ланцюжку (див. [тут](/developers/docs/data-and-analytics/block-explorers/)).

Однак користувач може забажати надіслати запит безпосередньо до даних, щоб звірити інформацію, надану зовнішніми оглядачами блоків. [Dune Analytics](https://dune.com/) надає таку можливість усім, хто має певні знання SQL.

Для довідки: обліковий запис смарт-контракту Ethereum Foundation (EF) можна переглянути на [Blockscout](https://eth.blockscout.com/address/0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe).

Слід зазначити, що всі облікові записи, включно з EF, мають публічну адресу, яку можна використовувати для надсилання та отримання транзакцій.

Баланс облікового запису на Etherscan складається зі звичайних і внутрішніх транзакцій. Внутрішні транзакції, попри назву, не є _фактичними_ транзакціями, які змінюють стан ланцюжка. Це перекази коштів, ініційовані виконанням контракту ([джерело](https://ethereum.stackexchange.com/questions/3417/how-to-get-contract-internal-transactions)). Оскільки внутрішні транзакції не мають підпису, вони **не** включаються в блокчейн і до них не можна надіслати запит за допомогою Dune Analytics.

Тому цей посібник буде зосереджений на звичайних транзакціях. Запит до них можна надіслати таким чином:

```sql
WITH temp_table AS (
SELECT
    hash,
    block_number,
    block_time,
    "from",
    "to",
    value / 1e18 AS ether,
    gas_used,
    gas_price / 1e9 AS gas_price_gwei
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
)
SELECT
    hash,
    block_number,
    block_time,
    "from",
    "to",
    ether,
    (gas_used * gas_price_gwei) / 1e9 AS txn_fee
FROM temp_table
```

Це дасть ту саму інформацію, що й на сторінці транзакцій Etherscan. Для порівняння, ось два джерела:

#### Etherscan {#etherscan}

![](./etherscan_view.png)

[Сторінка контракту EF на Blockscout.](https://eth.blockscout.com/address/0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe)

#### Dune Analytics {#dune-analytics}

![](./dune_view.png)

Ви можете знайти інформаційну панель [тут](https://dune.com/paulapivat/Learn-Ethereum). Натисніть на таблицю, щоб переглянути запит (також див. вище).

### Аналіз транзакцій {#breaking_down_transactions}

Надіслана транзакція включає кілька частин інформації, зокрема ([джерело](/developers/docs/transactions/)):

- **Одержувач**: адреса отримання (у запиті як "to")
- **Підпис**: хоча транзакція підписується приватними ключами відправника, за допомогою SQL ми можемо зробити запит до публічної адреси відправника ("from").
- **Значення**: це сума переказаних ETH (див. стовпець `ether`).
- **Дані**: це довільні дані, які були хешовані (див. стовпець `data`)
- **gasLimit** – максимальна кількість одиниць газу, яку може спожити транзакція. Одиниці газу представляють обчислювальні кроки
- **maxPriorityFeePerGas** – максимальна сума газу, що буде включена як «чайові» для майнера
- **maxFeePerGas** – максимальна сума газу, яку ви готові заплатити за транзакцію (включно з baseFeePerGas і maxPriorityFeePerGas)

Ми можемо надіслати запит до цих конкретних частин інформації для транзакцій на публічну адресу Ethereum Foundation:

```sql
SELECT
    "to",
    "from",
    value / 1e18 AS ether,
    data,
    gas_limit,
    gas_price / 1e9 AS gas_price_gwei,
    gas_used,
    ROUND(((gas_used / gas_limit) * 100),2) AS gas_used_pct
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
```

### Блоки {#blocks}

Кожна транзакція змінює стан віртуальної машини Ethereum ([EVM](/developers/docs/evm/)) ([джерело](/developers/docs/transactions/)). Транзакції транслюються в мережу для перевірки та включення в блок. Кожна транзакція пов’язана з номером блоку. Щоб переглянути дані, ми можемо надіслати запит до певного номера блоку: 12396854 (останній блок серед транзакцій Ethereum Foundation на момент написання, 11.05.21).

Крім того, коли ми надсилаємо запит до наступних двох блоків, ми можемо побачити, що кожен блок містить хеш попереднього блоку (тобто батьківський хеш), що ілюструє, як формується блокчейн.

Кожен блок містить посилання на свій батьківський блок. Це показано нижче між стовпцями `hash` і `parent_hash` ([джерело](/developers/docs/blocks/)):

![parent_hash](./parent_hash.png)

Ось [запит](https://dune.com/queries/44856/88292) на Dune Analytics:

```sql
SELECT
   time,
   number,
   hash,
   parent_hash,
   nonce
FROM ethereum."blocks"
WHERE "number" = 12396854 OR "number" = 12396855 OR "number" = 12396856
LIMIT 10
```

Ми можемо дослідити блок, надіславши запит щодо часу, номера блоку, складності, хешу, батьківського хешу та одноразового номера.

Єдине, що не охоплює цей запит, – це _список транзакцій_, для якого потрібен окремий запит нижче, і _корінь стану_. Повний або архівний вузол зберігатиме всі транзакції та переходи станів, дозволяючи клієнтам надсилати запити щодо стану ланцюжка в будь-який час. Оскільки для цього потрібен великий обсяг пам’яті, ми можемо відокремити дані ланцюжка від даних стану:

- Дані ланцюжка (список блоків, транзакцій)
- Дані стану (результат переходу стану кожної транзакції)

Корінь стану належить до останнього й є _неявними_ даними (не зберігаються в ланцюжку), тоді як дані ланцюжка є явними та зберігаються в самому ланцюжку ([джерело](https://ethereum.stackexchange.com/questions/359/where-is-the-state-data-stored)).

У цьому посібнику ми зосередимося на даних у ланцюжку, до яких _можна_ надіслати запит за допомогою SQL через Dune Analytics.

Як зазначено вище, кожен блок містить список транзакцій; ми можемо надіслати запит, відфільтрувавши його за певним блоком. Спробуємо останній блок, 12396854:

```sql
SELECT * FROM ethereum."transactions"
WHERE block_number = 12396854
ORDER BY block_time DESC`
```

Ось результат SQL-запиту на Dune:

![](./list_of_txn.png)

Цей єдиний блок, що додається до ланцюжка, змінює стан віртуальної машини Ethereum ([EVM](/developers/docs/evm/)). Десятки, а іноді й сотні транзакцій перевіряються одночасно. У цьому конкретному випадку було включено 222 транзакції.

Щоб побачити, скільки з них були насправді успішними, ми додамо ще один фільтр для підрахунку успішних транзакцій:

```sql
WITH temp_table AS (
    SELECT * FROM ethereum."transactions"
    WHERE block_number = 12396854 AND success = true
    ORDER BY block_time DESC
)
SELECT
    COUNT(success) AS num_successful_txn
FROM temp_table
```

Для блоку 12396854 із 222 транзакцій 204 було успішно перевірено:

![](./successful_txn.png)

Запити на транзакції відбуваються десятки разів на секунду, але блоки додаються приблизно раз на 15 секунд ([джерело](/developers/docs/blocks/)).

Щоб переконатися, що один блок створюється приблизно кожні 15 секунд, ми можемо взяти кількість секунд на добу (86400), розділити її на 15, щоб отримати орієнтовну середню кількість блоків на день (~5760).

Діаграма блоків Ethereum, що створюються за день (з 2016 року дотепер):

![](./daily_blocks.png)

Середня кількість блоків, що створюються щодня за цей період, становить ~5874:

![](./avg_daily_blocks.png)

Запити:

```sql
# запит для візуалізації кількості блоків, що створюються щодня з 2016 року

SELECT
    DATE_TRUNC('day', time) AS dt,
    COUNT(*) AS block_count
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1

# середня кількість блоків, що створюються за день

WITH temp_table AS (
SELECT
    DATE_TRUNC('day', time) AS dt,
    COUNT(*) AS block_count
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
)
SELECT
    AVG(block_count) AS avg_block_count
FROM temp_table
```

Середня кількість блоків, що створюються на день із 2016 року, трохи перевищує це число і становить 5874. Крім того, якщо розділити 86400 секунд на 5874 середніх блоків, вийде 14,7 секунди, або приблизно один блок кожні 15 секунд.

### Газ {#gas}

Блоки обмежені за розміром. Максимальний розмір блоку є динамічним і змінюється залежно від попиту в мережі від 12 500 000 до 25 000 000 одиниць. Ліміти необхідні, щоб запобігти довільно великим розмірам блоків, які створюють навантаження на повні вузли з погляду дискового простору та вимог до швидкості ([джерело](/developers/docs/blocks/)).

Один зі способів концептуалізувати ліміт газу для блоку — це уявити його як **пропозицію** доступного простору блоку для пакетування транзакцій. Ліміт газу для блоку можна запитати та візуалізувати з 2016 року до сьогодні:

![](./avg_gas_limit.png)

```sql
SELECT
    DATE_TRUNC('day', time) AS dt,
    AVG(gas_limit) AS avg_block_gas_limit
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
```

Далі йде фактичний обсяг газу, що використовується щодня для оплати обчислень у ланцюжку Ethereum (тобто надсилання транзакції, виклик смарт-контракту, карбування NFT). Це **попит** на доступний простір блоку Ethereum:

![](./daily_gas_used.png)

```sql
SELECT
    DATE_TRUNC('day', time) AS dt,
    AVG(gas_used) AS avg_block_gas_used
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
```

Ми також можемо зіставити ці дві діаграми, щоб побачити, як співвідносяться **попит і пропозиція**:

![gas_demand_supply](./gas_demand_supply.png)

Тому ми можемо розуміти ціни на газ як функцію попиту на простір блоку Ethereum за наявної пропозиції.

Нарешті, ми можемо захотіти запитати середньодобові ціни на газ для ланцюжка Ethereum, однак це призведе до особливо тривалого часу виконання запиту, тому ми відфільтруємо наш запит до середньої кількості газу, сплаченої за транзакцію Ethereum Foundation.

![](./ef_daily_gas.png)

Ми можемо бачити ціни на газ, сплачені за всі транзакції, здійснені на адресу Ethereum Foundation протягом багатьох років. Ось запит:

```sql
SELECT
    block_time,
    gas_price / 1e9 AS gas_price_gwei,
    value / 1e18 AS eth_sent
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
```

### Підсумок {#summary}

За допомогою цього посібника ми розібралися з основними концепціями Ethereum і тим, як працює блокчейн Ethereum, надсилаючи запити та знайомлячись із даними в ланцюжку.

Інформаційна панель, яка містить весь код, використаний у цьому посібнику, доступна [тут](https://dune.com/paulapivat/Learn-Ethereum).

Щоб дізнатися більше про використання даних для дослідження web3, [знайдіть мене у Twitter](https://twitter.com/paulapivat).
