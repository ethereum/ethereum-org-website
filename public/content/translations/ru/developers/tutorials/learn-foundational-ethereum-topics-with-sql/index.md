---
title: "Изучите основные темы Ethereum с помощью SQL"
description: "Это руководство помогает читателям понять основополагающие концепции Ethereum, включая транзакции, блоки и газ, путем запроса он-чейн данных с помощью языка структурированных запросов (SQL)."
author: "Paul Apivat"
tags: [ "SQL", "Запросы", "Транзакции" ]
skill: beginner
lang: ru
published: 2021-05-11
source: paulapivat.com
sourceUrl: https://paulapivat.com/post/query_ethereum/
---

Многие руководства по Ethereum предназначены для разработчиков, но не хватает образовательных ресурсов для аналитиков данных или для людей, которые хотят видеть он-чейн данные без запуска клиента или узла.

Это руководство помогает читателям понять основополагающие концепции Ethereum, включая транзакции, блоки и газ, путем запроса он-чейн данных с помощью языка структурированных запросов (SQL) через интерфейс, предоставляемый [Dune Analytics](https://dune.com/).

Он-чейн данные могут помочь нам понять Ethereum как сеть и как экономику вычислительной мощности, а также должны служить основой для понимания проблем, с которыми сегодня сталкивается Ethereum (например, растущие цены на газ), и, что более важно, обсуждений решений по масштабированию.

### Транзакции {#transactions}

Путь пользователя в Ethereum начинается с инициализации управляемого пользователем аккаунта или сущности с балансом ETH. Существует два типа аккаунтов: управляемый пользователем или смарт-контракт (см. [ethereum.org](/developers/docs/accounts/)).

Любой аккаунт можно просмотреть в обозревателе блоков, таком как [Etherscan](https://etherscan.io/) или [Blockscout](https://eth.blockscout.com/). Обозреватели блоков — это портал к данным Ethereum. Они отображают в реальном времени данные о блоках, транзакциях, майнерах, аккаунтах и другой он-чейн активности (см. [здесь](/developers/docs/data-and-analytics/block-explorers/)).

Однако пользователь может захотеть запросить данные напрямую для сверки информации, предоставляемой внешними обозревателями блоков. [Dune Analytics](https://dune.com/) предоставляет эту возможность любому, кто имеет некоторые знания SQL.

Для справки: аккаунт смарт-контракта Ethereum Foundation (EF) можно просмотреть на [Blockscout](https://eth.blockscout.com/address/0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe).

Следует отметить, что все аккаунты, включая аккаунт EF, имеют публичный адрес, который можно использовать для отправки и получения транзакций.

Баланс аккаунта на Etherscan включает в себя обычные и внутренние транзакции. Внутренние транзакции, несмотря на название, не являются _настоящими_ транзакциями, которые изменяют состояние цепи. Это переводы средств, инициированные выполнением контракта ([источник](https://ethereum.stackexchange.com/questions/3417/how-to-get-contract-internal-transactions)). Поскольку внутренние транзакции не имеют подписи, они **не** включаются в блокчейн и не могут быть запрошены с помощью Dune Analytics.

Поэтому это руководство будет посвящено обычным транзакциям. Это можно запросить следующим образом:

```sql
WITH temp_table AS (
SELECT
    hash,
    block_number,
    block_time,
    "from",
    "to",
    value / 1e18 AS ether,
    gas_used,
    gas_price / 1e9 AS gas_price_gwei
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
)
SELECT
    hash,
    block_number,
    block_time,
    "from",
    "to",
    ether,
    (gas_used * gas_price_gwei) / 1e9 AS txn_fee
FROM temp_table
```

Это даст ту же информацию, что и на странице транзакций Etherscan. Для сравнения, вот два источника:

#### Etherscan {#etherscan}

![](./etherscan_view.png)

[Страница контракта EF на Blockscout.](https://eth.blockscout.com/address/0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe)

#### Dune Analytics {#dune-analytics}

![](./dune_view.png)

Вы можете найти панель управления [здесь](https://dune.com/paulapivat/Learn-Ethereum). Нажмите на таблицу, чтобы увидеть запрос (также см. выше).

### Разбор транзакций {#breaking_down_transactions}

Отправленная транзакция включает в себя несколько частей информации, в том числе ([источник](/developers/docs/transactions/)):

- **Получатель**: адрес получателя (запрашивается как "to")
- **Подпись**: хотя приватный ключ отправителя подписывает транзакцию, с помощью SQL мы можем запросить публичный адрес отправителя ("from").
- **Значение**: это количество переданных ETH (см. столбец `ether`).
- **Данные**: это произвольные данные, которые были хэшированы (см. столбец `data`)
- **gasLimit** — максимальное количество единиц газа, которое может быть использовано транзакцией. Единицы газа представляют собой вычислительные шаги
- **maxPriorityFeePerGas** — максимальное количество газа, которое можно использовать в качестве награды для майнера
- **maxFeePerGas** — максимальное количество газа, которое будет выплачено за транзакцию (включая baseFeePerGas и maxPriorityFeePerGas)

Мы можем запросить эти конкретные части информации для транзакций на публичный адрес Ethereum Foundation:

```sql
SELECT
    "to",
    "from",
    value / 1e18 AS ether,
    data,
    gas_limit,
    gas_price / 1e9 AS gas_price_gwei,
    gas_used,
    ROUND(((gas_used / gas_limit) * 100),2) AS gas_used_pct
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
```

### Блоки {#blocks}

Каждая транзакция изменяет состояние виртуальной машины Ethereum ([EVM](/developers/docs/evm/)) ([источник](/developers/docs/transactions/)). Транзакции транслируются в сеть для проверки и включения в блок. Каждая транзакция связана с номером блока. Чтобы увидеть данные, мы можем запросить конкретный номер блока: 12396854 (самый последний блок среди транзакций Ethereum Foundation на момент написания статьи, 11/5/21).

Более того, когда мы запрашиваем следующие два блока, мы видим, что каждый блок содержит хэш предыдущего блока (т. е. родительский хэш), что иллюстрирует, как формируется блокчейн.

Каждый блок содержит ссылку на родительский блок. Это показано ниже между столбцами `hash` и `parent_hash` ([источник](/developers/docs/blocks/)):

![parent_hash](./parent_hash.png)

Вот [запрос](https://dune.com/queries/44856/88292) в Dune Analytics:

```sql
SELECT
   time,
   number,
   hash,
   parent_hash,
   nonce
FROM ethereum."blocks"
WHERE "number" = 12396854 OR "number" = 12396855 OR "number" = 12396856
LIMIT 10
```

Мы можем изучить блок, запросив время, номер блока, сложность, хэш, родительский хэш и nonce.

Единственное, что этот запрос не охватывает, это _список транзакций_, который требует отдельного запроса ниже, и _корень состояния_. Полный или архивный узел будет хранить все транзакции и переходы состояний, позволяя клиентам запрашивать состояние цепи в любой момент времени. Поскольку это требует большого дискового пространства, мы можем отделить данные цепи от данных о состоянии:

- Данные цепи (список блоков, транзакций)
- Данные о состоянии (результат перехода состояния каждой транзакции)

Корень состояния относится ко второму типу и является _неявными_ данными (не хранится он-чейн), в то время как данные цепи являются явными и хранятся в самой цепи ([источник](https://ethereum.stackexchange.com/questions/359/where-is-the-state-data-stored)).

В этом руководстве мы сосредоточимся на он-чейн данных, которые _можно_ запрашивать с помощью SQL через Dune Analytics.

Как указано выше, каждый блок содержит список транзакций, и мы можем запросить его, отфильтровав по конкретному блоку. Попробуем самый последний блок, 12396854:

```sql
SELECT * FROM ethereum."transactions"
WHERE block_number = 12396854
ORDER BY block_time DESC`
```

Вот вывод SQL в Dune:

![](./list_of_txn.png)

Добавление этого одного блока в цепь изменяет состояние виртуальной машины Ethereum ([EVM](/developers/docs/evm/)). За раз проверяются десятки, а иногда и сотни транзакций. В этом конкретном случае было включено 222 транзакции.

Чтобы увидеть, сколько из них были действительно успешными, мы добавим еще один фильтр для подсчета успешных транзакций:

```sql
WITH temp_table AS (
    SELECT * FROM ethereum."transactions"
    WHERE block_number = 12396854 AND success = true
    ORDER BY block_time DESC
)
SELECT
    COUNT(success) AS num_successful_txn
FROM temp_table
```

Для блока 12396854 из 222 транзакций 204 были успешно проверены:

![](./successful_txn.png)

Запросы на транзакции происходят десятки раз в секунду, но блоки фиксируются примерно раз в 15 секунд ([источник](/developers/docs/blocks/)).

Чтобы убедиться, что один блок создается примерно каждые 15 секунд, мы можем взять количество секунд в дне (86 400) и разделить на 15, чтобы получить примерное среднее количество блоков в день (~ 5760).

График созданных блоков Ethereum в день (с 2016 г. по настоящее время):

![](./daily_blocks.png)

Среднее количество блоков, создаваемых ежедневно за этот период, составляет ~5874:

![](./avg_daily_blocks.png)

Запросы:

```sql
# запрос для визуализации количества блоков, создаваемых ежедневно с 2016 года

SELECT
    DATE_TRUNC('day', time) AS dt,
    COUNT(*) AS block_count
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1

# среднее количество блоков, создаваемых в день

WITH temp_table AS (
SELECT
    DATE_TRUNC('day', time) AS dt,
    COUNT(*) AS block_count
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
)
SELECT
    AVG(block_count) AS avg_block_count
FROM temp_table
```

Среднее количество блоков, создаваемых в день с 2016 года, немного превышает это число и составляет 5874. С другой стороны, деление 86 400 секунд на 5874 (среднее количество блоков) дает 14,7 секунды, или примерно один блок каждые 15 секунд.

### Газ {#gas}

Размер блоков ограничен. Максимальный размер блока динамичен и варьируется в зависимости от спроса в сети от 12 500 000 до 25 000 000 единиц. Ограничения необходимы, чтобы предотвратить произвольно большие размеры блоков, создающие нагрузку на полные узлы с точки зрения требований к дисковому пространству и скорости ([источник](/developers/docs/blocks/)).

Один из способов осмыслить лимит газа блока — это думать о нем как о **предложении** доступного пространства в блоке, в котором можно пакетировать транзакции. Лимит газа блока можно запросить и визуализировать с 2016 года по сегодняшний день:

![](./avg_gas_limit.png)

```sql
SELECT
    DATE_TRUNC('day', time) AS dt,
    AVG(gas_limit) AS avg_block_gas_limit
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
```

Затем есть фактический газ, используемый ежедневно для оплаты вычислений, выполняемых в цепи Ethereum (т. е. отправка транзакции, вызов смарт-контракта, минтинг NFT). Это **спрос** на доступное пространство в блоках Ethereum:

![](./daily_gas_used.png)

```sql
SELECT
    DATE_TRUNC('day', time) AS dt,
    AVG(gas_used) AS avg_block_gas_used
FROM ethereum."blocks"
GROUP BY dt
OFFSET 1
```

Мы также можем сопоставить эти два графика, чтобы увидеть, как соотносятся **спрос и предложение**:

![gas_demand_supply](./gas_demand_supply.png)

Таким образом, мы можем понимать цены на газ как функцию спроса на пространство в блоках Ethereum, учитывая имеющееся предложение.

Наконец, мы можем захотеть запросить средние дневные цены на газ для цепи Ethereum, однако это приведет к особенно долгому времени выполнения запроса, поэтому мы отфильтруем наш запрос до среднего количества газа, уплаченного за транзакцию Ethereum Foundation.

![](./ef_daily_gas.png)

Мы можем видеть цены на газ, уплаченные за все транзакции, сделанные на адрес Ethereum Foundation за эти годы. Вот запрос:

```sql
SELECT
    block_time,
    gas_price / 1e9 AS gas_price_gwei,
    value / 1e18 AS eth_sent
FROM ethereum."transactions"
WHERE "to" = '\xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe'
ORDER BY block_time DESC
```

### Сводка {#summary}

С помощью этого руководства мы поняли основополагающие концепции Ethereum и то, как работает блокчейн Ethereum, запрашивая и знакомясь с он-чейн данными.

Панель управления, содержащая весь код, использованный в этом руководстве, находится [здесь](https://dune.com/paulapivat/Learn-Ethereum).

Чтобы узнать больше об использовании данных для изучения Web3, [найдите меня в Twitter](https://twitter.com/paulapivat).
