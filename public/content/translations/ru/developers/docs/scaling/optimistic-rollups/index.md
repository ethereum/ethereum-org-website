---
title: Оптимистичный ролл-ап
description: Введение в оптимистичные роллапы — решение для масштабирования, используемое сообществом Ethereum.
lang: ru
---

Оптимистичные свертки — это протоколы уровня 2 (L2), предназначенные для расширения пропускной способности базового уровня Ethereum. Они сокращают объем вычислений в основной цепочке Ethereum за счет обработки транзакций вне цепочки, что обеспечивает значительное повышение скорости обработки. В отличие от других решений для масштабирования, таких как [сайдчейны](/developers/docs/scaling/sidechains/), оптимистические ролл-апы обеспечивают безопасность за счет основной сети, публикуя результаты транзакций в сети (on-chain), или [цепей Plasma](/developers/docs/scaling/plasma/), которые также проверяют транзакции в Ethereum с помощью доказательств мошенничества, но хранят данные транзакций в другом месте.

Поскольку вычисления — это медленная и затратная часть использования Ethereum, оптимистичные накопления могут обеспечить улучшение масштабируемости в 10–100 раз. Оптимистические ролл-апы также записывают транзакции в Ethereum как `calldata` или в виде [блобов](/roadmap/danksharding/), что снижает расходы пользователей на газ.

## Предварительные условия {#prerequisites}

Вам следует прочитать и понять наши страницы о [масштабировании Ethereum](/developers/docs/scaling/) и [уровне 2](/layer-2/).

## Что такое оптимистичный свертывающий прогноз? {#what-is-an-optimistic-rollup}

Оптимистичный подход к масштабированию Ethereum подразумевает перемещение вычислений и хранения состояний за пределы блокчейна. Оптимистические ролл-апы выполняют транзакции вне Ethereum, но публикуют данные транзакций в основной сети в виде `calldata` или в [блобах](/roadmap/danksharding/).

Оптимистичные операторы объединяют несколько офчейн-транзакций в большие пакеты перед отправкой в ​​Ethereum. Такой подход позволяет распределить фиксированные издержки по нескольким транзакциям в каждом пакете, снижая комиссию для конечных пользователей. Оптимистичные свертки также используют методы сжатия для уменьшения объема данных, размещаемых на Ethereum.

Оптимистичные свертки считаются «оптимистичными», поскольку они предполагают, что транзакции вне сети являются действительными, и не публикуют доказательства действительности для пакетов транзакций, размещенных в сети. Это отличает оптимистические ролл-апы от [ролл-апов с 0-знанием](/developers/docs/scaling/zk-rollups), которые публикуют криптографические [доказательства действительности](/glossary/#validity-proof) для транзакций вне сети.

Вместо этого оптимистические ролл-апы используют схему доказательства мошенничества для выявления случаев, когда транзакции рассчитываются неверно. После того как пакет ролл-апа отправлен в Ethereum, есть временное окно (называемое периодом оспаривания), в течение которого любой может оспорить результаты транзакции ролл-апа, вычислив [доказательство мошенничества](/glossary/#fraud-proof).

Если доказательство мошенничества будет успешным, протокол ролл-апа повторно выполнит транзакцию (транзакции) и соответствующим образом обновит состояние ролл-апа. Другим следствием успешного доказательства мошенничества является то, что Секвенсор, ответственный за включение неверно выполненной транзакции в блок, получает штраф.

Если пакет ролл-апа остается неоспоренным (т. е. все транзакции выполнены правильно) по истечении периода оспаривания, он считается действительным и принимается в Ethereum. Другие могут продолжать строить на неподтвержденном блоке ролл-апа, но с оговоркой: результаты транзакций будут отменены, если они основаны на неверно выполненной транзакции, опубликованной ранее.

## Как оптимистические ролл-апы взаимодействуют с Ethereum? {#optimistic-rollups-and-Ethereum}

Оптимистические ролл-апы — это [решения для масштабирования вне сети](/developers/docs/scaling/#offchain-scaling), созданные для работы поверх Ethereum. Каждый оптимистический ролл-ап управляется набором смарт-контрактов, развернутых в сети Ethereum. Оптимистические ролл-апы обрабатывают транзакции вне основной цепи Ethereum, но публикуют транзакции вне сети (пакетами) в контракте ролл-апа в сети. Как и блокчейн Ethereum, эта запись транзакций является неизменной и образует "цепь оптимистического ролл-апа".

Архитектура оптимистического ролл-апа включает следующие части:

**Контракты в сети**: работа оптимистического ролл-апа контролируется смарт-контрактами, работающими в Ethereum. Это включает контракты, которые хранят блоки ролл-апа, отслеживают обновления состояния в ролл-апе и отслеживают депозиты пользователей. В этом смысле Ethereum служит базовым уровнем, или "уровнем 1", для оптимистических ролл-апов.

**Виртуальная машина вне сети (VM)**: хотя контракты, управляющие протоколом оптимистического ролл-апа, работают в Ethereum, протокол ролл-апа выполняет вычисления и хранение состояний на другой виртуальной машине, отдельной от [виртуальной машины Ethereum](/developers/docs/evm/). VM вне сети — это место, где находятся приложения и выполняются изменения состояния; она служит верхним уровнем, или "уровнем 2", для оптимистического ролл-апа.

Поскольку оптимистические ролл-апы предназначены для запуска программ, написанных или скомпилированных для EVM, VM вне сети включает в себя многие проектные спецификации EVM. Кроме того, доказательства мошенничества, вычисленные в сети, позволяют сети Ethereum обеспечивать действительность изменений состояния, вычисленных в VM вне сети.

Оптимистические ролл-апы описываются как 'гибридные решения для масштабирования', потому что, хотя они существуют как отдельные протоколы, их свойства безопасности унаследованы от Ethereum. Помимо прочего, Ethereum гарантирует правильность вычислений ролл-апа вне сети и доступность данных, лежащих в основе этих вычислений. Это делает оптимистические ролл-апы более безопасными, чем чисто протоколы масштабирования вне сети (например, [сайдчейны](/developers/docs/scaling/sidechains/)), которые не полагаются на Ethereum для обеспечения безопасности.

Оптимистические ролл-апы полагаются на основной протокол Ethereum в следующих аспектах:

### Доступность данных {#data-availability}

Как уже упоминалось, оптимистические ролл-апы публикуют данные транзакций в Ethereum в виде `calldata` или [блобов](/roadmap/danksharding/). Поскольку выполнение цепи ролл-апа основано на отправленных транзакциях, любой может использовать эту информацию, закрепленную на базовом уровне Ethereum, для выполнения состояния ролл-апа и проверки правильности переходов состояний.

[Доступность данных](/developers/docs/data-availability/) имеет решающее значение, поскольку без доступа к данным о состоянии оспаривающие стороны не могут создавать доказательства мошенничества для оспаривания недействительных операций ролл-апа. Благодаря тому, что Ethereum обеспечивает доступность данных, снижается риск того, что операторы ролл-апа смогут безнаказанно совершать злонамеренные действия (например, отправлять недействительные блоки).

### Устойчивость к цензуре {#censorship-resistance}

Оптимистические ролл-апы также полагаются на Ethereum для обеспечения устойчивости к цензуре. В оптимистическом ролл-апе централизованная сущность (оператор) отвечает за обработку транзакций и отправку блоков ролл-апа в Ethereum. Это имеет некоторые последствия:

- Операторы ролл-апа могут подвергать пользователей цензуре, полностью отключаясь от сети или отказываясь создавать блоки, включающие в себя определенные транзакции.

- Операторы ролл-апа могут помешать пользователям выводить средства, внесенные в контракт ролл-апа, удерживая данные о состоянии, необходимые для доказательств владения Меркла. Удержание данных о состоянии также может скрыть состояние ролл-апа от пользователей и помешать им взаимодействовать с ролл-апом.

Оптимистические ролл-апы решают эту проблему, заставляя операторов публиковать данные, связанные с обновлениями состояния, в Ethereum. Публикация данных ролл-апа в сети имеет следующие преимущества:

- Если оператор оптимистического ролл-апа отключается от сети или прекращает создавать пакеты транзакций, другой узел может использовать доступные данные для воспроизведения последнего состояния ролл-апа и продолжения производства блоков.

- Пользователи могут использовать данные транзакций для создания доказательств Меркла, подтверждающих владение средствами, и выводить свои активы из ролл-апа.

- Пользователи также могут отправлять свои транзакции на L1 вместо Секвенсора, и в этом случае Секвенсор должен включить транзакцию в течение определенного времени, чтобы продолжать создавать действительные блоки.

### Расчет {#settlement}

Еще одна роль, которую Ethereum играет в контексте оптимистических ролл-апов, — это роль расчетного уровня. Расчетный уровень закрепляет всю экосистему блокчейна, обеспечивает безопасность и объективную окончательность в случае возникновения спора на другой цепи (в данном случае, на оптимистических ролл-апах), требующего арбитража.

Основная сеть Ethereum предоставляет центр для оптимистических ролл-апов для проверки доказательств мошенничества и разрешения споров. Более того, транзакции, проведенные в ролл-апе, становятся окончательными только _после_ того, как блок ролл-апа будет принят в Ethereum. Как только транзакция ролл-апа зафиксирована на базовом уровне Ethereum, ее нельзя отменить (за исключением крайне маловероятного случая реорганизации цепи).

## Как работают оптимистические ролл-апы? {#how-optimistic-rollups-work}

### Выполнение и агрегация транзакций {#transaction-execution-and-aggregation}

Пользователи отправляют транзакции "операторам" — узлам, ответственным за обработку транзакций в оптимистическом ролл-апе. Также известный как "валидатор" или "агрегатор", оператор агрегирует транзакции, сжимает базовые данные и публикует блок в Ethereum.

Хотя любой может стать валидатором, валидаторы оптимистического ролл-апа должны предоставить залог перед созданием блоков, подобно [системе proof-of-stake](/developers/docs/consensus-mechanisms/pos/). Этот залог может быть уменьшен (slashed), если валидатор публикует недействительный блок или строит на старом, но недействительном блоке (даже если его собственный блок действителен). Таким образом, оптимистические ролл-апы используют криптоэкономические стимулы для обеспечения честной работы валидаторов.

Ожидается, что другие валидаторы в цепи оптимистического ролл-апа будут выполнять отправленные транзакции, используя свою копию состояния ролл-апа. Если конечное состояние валидатора отличается от предложенного состояния оператора, они могут начать оспаривание и вычислить доказательство мошенничества.

Некоторые оптимистические ролл-апы могут отказаться от безразрешительной системы валидаторов и использовать одного "Секвенсора" для выполнения цепи. Подобно валидатору, Секвенсор обрабатывает транзакции, создает блоки ролл-апа и отправляет транзакции ролл-апа в цепь L1 (Ethereum).

Секвенсор отличается от обычного оператора ролл-апа, поскольку он имеет больший контроль над порядком транзакций. Кроме того, Секвенсор имеет приоритетный доступ к цепи ролл-апа и является единственным субъектом, уполномоченным отправлять транзакции в контракт в сети. Транзакции от узлов, не являющихся Секвенсорами, или от обычных пользователей просто ставятся в очередь в отдельный почтовый ящик, пока Секвенсор не включит их в новый пакет.

#### Отправка блоков ролл-апа в Ethereum {#submitting-blocks-to-ethereum}

Как уже упоминалось, оператор оптимистического ролл-апа объединяет транзакции вне сети в пакет и отправляет его в Ethereum для нотариального заверения. Этот процесс включает сжатие данных, связанных с транзакциями, и их публикацию в Ethereum в виде `calldata` или в виде блобов.

`calldata` — это немодифицируемая, непостоянная область в смарт-контракте, которая в основном ведет себя как [память](/developers/docs/smart-contracts/anatomy/#memory). Хотя `calldata` сохраняется в сети как часть [журналов истории](https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html?highlight=memory#logs) блокчейна, она не хранится как часть состояния Ethereum. Поскольку `calldata` не затрагивает ни одну часть состояния Ethereum, она дешевле, чем состояние, для хранения данных в сети.

Ключевое слово `calldata` также используется в Solidity для передачи аргументов в функцию смарт-контракта во время выполнения. `calldata` идентифицирует вызываемую функцию во время транзакции и содержит входные данные для функции в виде произвольной последовательности байтов.

В контексте оптимистических ролл-апов `calldata` используется для отправки сжатых данных транзакций в контракт в сети. Оператор ролл-апа добавляет новый пакет, вызывая требуемую функцию в контракте ролл-апа и передавая сжатые данные в качестве аргументов функции. Использование `calldata` снижает комиссию для пользователей, поскольку большинство затрат, которые несут ролл-апы, связаны с хранением данных в сети.

Вот [пример](https://eth.blockscout.com/tx/0x9102bfce17c58b5fc1c974c24b6bb7a924fb5fbd7c4cd2f675911c27422a5591) отправки пакета ролл-апа, чтобы показать, как работает эта концепция. Секвенсор вызвал метод `appendSequencerBatch()` и передал сжатые данные транзакции в качестве входных данных с помощью `calldata`.

Некоторые ролл-апы теперь используют блобы для отправки пакетов транзакций в Ethereum.

Блобы немодифицируемы и непостоянны (как и `calldata`), но удаляются из истории примерно через 18 дней. Для получения дополнительной информации о блобах см. [Danksharding](/roadmap/danksharding).

### Обязательства по состоянию {#state-commitments}

В любой момент времени состояние оптимистического ролл-апа (аккаунты, балансы, код контракта и т. д.) организовано в виде [дерева Меркла](/whitepaper/#merkle-trees), называемого «деревом состояний». Корень этого дерева Меркла (корень состояния), который ссылается на последнее состояние ролл-апа, хэшируется и хранится в контракте ролл-апа. Каждый переход состояния в цепи создает новое состояние ролл-апа, которое оператор фиксирует, вычисляя новый корень состояния.

Оператор должен отправлять как старые, так и новые корни состояний при публикации пакетов. Если старый корень состояния совпадает с существующим корнем состояния в контракте в сети, последний отбрасывается и заменяется новым корнем состояния.

Оператор ролл-апа также должен зафиксировать корень Меркла для самого пакета транзакций. Это позволяет любому доказать включение транзакции в пакет (на L1), представив [доказательство Меркла](/developers/tutorials/merkle-proofs-for-offline-data-integrity/).

Фиксации состояний, особенно корни состояний, необходимы для доказательства правильности изменений состояний в оптимистическом ролл-апе. Контракт ролл-апа принимает новые корни состояний от операторов сразу после их публикации, но может позже удалить недействительные корни состояний, чтобы восстановить ролл-ап до его правильного состояния.

### Доказательство мошенничества {#fraud-proving}

Как уже объяснялось, оптимистические ролл-апы позволяют любому публиковать блоки без предоставления доказательств действительности. Однако для обеспечения безопасности цепи оптимистические ролл-апы определяют временное окно, в течение которого любой может оспорить переход состояния. Поэтому блоки ролл-апа называются «утверждениями», так как любой может оспорить их действительность.

Если кто-то оспаривает утверждение, протокол ролл-апа инициирует вычисление доказательства мошенничества. Каждый тип доказательства мошенничества является интерактивным — кто-то должен опубликовать утверждение, прежде чем другой сможет его оспорить. Разница заключается в том, сколько раундов взаимодействия требуется для вычисления доказательства мошенничества.

Однораундовые интерактивные схемы доказательства воспроизводят оспариваемые транзакции на L1 для выявления недействительных утверждений. Протокол ролл-апа эмулирует повторное выполнение оспариваемой транзакции на L1 (Ethereum) с использованием контракта-верификатора, при этом вычисленный корень состояния определяет, кто выигрывает оспаривание. Если утверждение оспаривающей стороны о правильном состоянии ролл-апа верно, оператор наказывается уменьшением (slashing) своего залога.

Однако повторное выполнение транзакций на L1 для выявления мошенничества требует публикации фиксаций состояний для отдельных транзакций и увеличивает объем данных, которые ролл-апы должны публиковать в сети. Повторное воспроизведение транзакций также влечет за собой значительные затраты на газ. По этим причинам оптимистические ролл-апы переходят на многораундовое интерактивное доказательство, которое достигает той же цели (т. е. выявление недействительных операций ролл-апа) с большей эффективностью.

#### Многораундовое интерактивное доказательство {#multi-round-interactive-proving}

Многораундовое интерактивное доказательство включает в себя протокол взаимодействия между утверждающей и оспаривающей сторонами под контролем контракта-верификатора L1, который в конечном итоге определяет лгущую сторону. После того как узел L2 оспаривает утверждение, утверждающая сторона должна разделить оспариваемое утверждение на две равные половины. Каждое отдельное утверждение в этом случае будет содержать столько же шагов вычислений, сколько и другое.

Затем оспаривающая сторона выберет, какое утверждение она хочет оспорить. Процесс деления (называемый «протоколом деления пополам») продолжается до тех пор, пока обе стороны не будут оспаривать утверждение об _одном_ шаге выполнения. На этом этапе контракт L1 разрешит спор, оценив инструкцию (и ее результат), чтобы поймать мошенническую сторону.

Утверждающая сторона должна предоставить «одношаговое доказательство», подтверждающее действительность оспариваемого одношагового вычисления. Если утверждающая сторона не предоставляет одношаговое доказательство, или верификатор L1 считает доказательство недействительным, она проигрывает оспаривание.

Некоторые замечания об этом типе доказательства мошенничества:

1. Многораундовое интерактивное доказательство мошенничества считается эффективным, поскольку оно минимизирует работу, которую должна выполнять цепь L1 при арбитраже споров. Вместо повторного воспроизведения всей транзакции, цепи L1 нужно только повторно выполнить один шаг в выполнении ролл-апа.

2. Протоколы деления пополам уменьшают объем данных, публикуемых в сети (нет необходимости публиковать фиксации состояний для каждой транзакции). Кроме того, транзакции оптимистического ролл-апа не ограничены лимитом газа Ethereum. И наоборот, оптимистические ролл-апы, повторно выполняющие транзакции, должны убедиться, что транзакция L2 имеет более низкий лимит газа для эмуляции ее выполнения в рамках одной транзакции Ethereum.

3. Часть залога злонамеренного утверждающего присуждается оспаривающей стороне, а другая часть сжигается. Сжигание предотвращает сговор между валидаторами; если два валидатора вступят в сговор для инициирования фиктивных оспариваний, они все равно лишатся значительной части всей своей ставки.

4. Многораундовое интерактивное доказательство требует, чтобы обе стороны (утверждающая и оспаривающая) делали ходы в течение указанного временного окна. Невыполнение действий до истечения срока приводит к тому, что не выполнившая обязательства сторона проигрывает оспаривание.

#### Почему доказательства мошенничества важны для оптимистических ролл-апов {#fraud-proof-benefits}

Доказательства мошенничества важны, поскольку они способствуют _бездоверительной окончательности_ в оптимистических ролл-апах. Бездоверительная окончательность — это качество оптимистических ролл-апов, которое гарантирует, что транзакция, если она действительна, в конечном итоге будет подтверждена.

Злонамеренные узлы могут пытаться отсрочить подтверждение действительного блока ролл-апа, начиная ложные оспаривания. Однако доказательства мошенничества в конечном итоге докажут действительность блока ролл-апа и приведут к его подтверждению.

Это также связано с другим свойством безопасности оптимистических ролл-апов: действительность цепи зависит от существования _одного_ честного узла. Честный узел может правильно продвигать цепь, либо публикуя действительные утверждения, либо оспаривая недействительные. В любом случае, злонамеренные узлы, вступающие в споры с честным узлом, потеряют свои ставки в процессе доказательства мошенничества.

### Совместимость L1/L2 {#l1-l2-interoperability}

Оптимистические ролл-апы разработаны для взаимодействия с основной сетью Ethereum и позволяют пользователям передавать сообщения и произвольные данные между L1 и L2. Они также совместимы с EVM, поэтому вы можете переносить существующие [децентрализованные приложения](/developers/docs/dapps/) на оптимистические ролл-апы или создавать новые децентрализованные приложения с помощью инструментов разработки Ethereum.

#### 1. Перемещение активов {#asset-movement}

##### Вход в ролл-ап

Чтобы использовать оптимистический ролл-ап, пользователи вносят ETH, токены ERC-20 и другие принимаемые активы в контракт [Моста](/developers/docs/bridges/) ролл-апа на L1. Контракт Моста передаст транзакцию на L2, где будет выпущена эквивалентная сумма активов и отправлена на выбранный пользователем адрес в оптимистическом ролл-апе.

Транзакции, сгенерированные пользователем (например, депозит с L1 на L2), обычно ставятся в очередь до тех пор, пока Секвенсор не отправит их повторно в контракт ролл-апа. Однако, чтобы сохранить устойчивость к цензуре, оптимистические ролл-апы позволяют пользователям отправлять транзакцию непосредственно в контракт ролл-апа в сети, если она была задержана сверх максимально допустимого времени.

Некоторые оптимистические ролл-апы используют более простой подход для предотвращения цензуры пользователей Секвенсорами. Здесь блок определяется всеми транзакциями, отправленными в контракт L1 с момента предыдущего блока (например, депозиты), в дополнение к транзакциям, обработанным в цепи ролл-апа. Если Секвенсор игнорирует транзакцию L1, он опубликует (доказуемо) неверный корень состояния; следовательно, Секвенсоры не могут задерживать сообщения, сгенерированные пользователем, после их публикации на L1.

##### Выход из ролл-апа

Вывод средств из оптимистического ролл-апа в Ethereum сложнее из-за схемы доказательства мошенничества. Если пользователь инициирует транзакцию с L2 на L1 для вывода средств, зарезервированных на L1, он должен дождаться истечения периода оспаривания, который длится примерно семь дней. Тем не менее, сам процесс вывода средств довольно прост.

После инициирования запроса на вывод средств в ролл-апе L2, транзакция включается в следующий пакет, а активы пользователя в ролл-апе сжигаются. Как только пакет будет опубликован в Ethereum, пользователь сможет вычислить доказательство Меркла, подтверждающее включение его транзакции на выход в блок. Затем остается только дождаться окончания периода задержки, чтобы завершить транзакцию на L1 и вывести средства в основную сеть.

Чтобы не ждать неделю перед выводом средств в Ethereum, пользователи оптимистических ролл-апов могут воспользоваться услугами **поставщика ликвидности** (LP). Поставщик ликвидности принимает на себя владение ожидающим выводом средств с L2 и выплачивает пользователю на L1 (в обмен на комиссию).

Поставщики ликвидности могут проверить действительность запроса пользователя на вывод средств (самостоятельно выполнив цепь) перед выпуском средств. Таким образом, у них есть гарантии, что транзакция в конечном итоге будет подтверждена (т. е. бездоверительная окончательность).

#### 2. Совместимость с EVM {#evm-compatibility}

Для разработчиков преимущество оптимистических ролл-апов заключается в их совместимости — или, что еще лучше, эквивалентности — с [виртуальной машиной Ethereum (EVM)](/developers/docs/evm/). EVM-совместимые ролл-апы соответствуют спецификациям [Желтой книги Ethereum](https://ethereum.github.io/yellowpaper/paper.pdf) и поддерживают EVM на уровне байт-кода.

EVM-совместимость в оптимистических ролл-апах имеет следующие преимущества:

i. Разработчики могут переносить существующие смарт-контракты из Ethereum в цепи оптимистических ролл-апов без необходимости существенного изменения кодовых баз. Это может сэкономить время командам разработчиков при развертывании смарт-контрактов Ethereum на L2.

ii. Разработчики и проектные команды, использующие оптимистические ролл-апы, могут воспользоваться инфраструктурой Ethereum. Это включает языки программирования, библиотеки кода, инструменты тестирования, клиентское программное обеспечение, инфраструктуру развертывания и так далее.

Использование существующих инструментов важно, потому что эти инструменты были тщательно проверены, отлажены и улучшены на протяжении многих лет. Это также избавляет разработчиков Ethereum от необходимости изучать, как создавать приложения с совершенно новым стеком разработки.

#### 3. Вызовы контрактов между цепями {#cross-chain-contract-calls}

Пользователи (внешние аккаунты) взаимодействуют с контрактами L2, отправляя транзакцию в контракт ролл-апа или поручая это Секвенсору или валидатору. Оптимистические ролл-апы также позволяют аккаунтам контрактов в Ethereum взаимодействовать с контрактами L2, используя контракты Мостов для ретрансляции сообщений и передачи данных между L1 и L2. Это означает, что вы можете запрограммировать контракт L1 в основной сети Ethereum для вызова функций, принадлежащих контрактам в оптимистическом ролл-апе L2.

Вызовы контрактов между цепями происходят асинхронно, то есть вызов сначала инициируется, а затем выполняется позже. Это отличается от вызовов между двумя контрактами в Ethereum, где вызов дает результаты немедленно.

Примером вызова контракта между цепями является описанный ранее депозит токенов. Контракт на L1 блокирует токены пользователя и отправляет сообщение парному контракту на L2 для выпуска эквивалентного количества токенов в ролл-апе.

Поскольку вызовы сообщений между цепями приводят к выполнению контракта, отправитель обычно должен покрывать [затраты на газ](/developers/docs/gas/) для вычислений. Рекомендуется устанавливать высокий лимит газа, чтобы предотвратить сбой транзакции в целевой цепи. Сценарий моста для токенов — хороший пример; если сторона L1 транзакции (депонирование токенов) работает, а сторона L2 (выпуск новых токенов) не удается из-за низкого газа, депозит становится невозвратным.

Наконец, следует отметить, что вызовы сообщений с L2 на L1 между контрактами должны учитывать задержки (вызовы с L1 на L2 обычно выполняются через несколько минут). Это связано с тем, что сообщения, отправленные в основную сеть из оптимистического ролл-апа, не могут быть выполнены до истечения окна оспаривания.

## Как работают комиссии в оптимистических ролл-апах? {#how-do-optimistic-rollup-fees-work}

Оптимистические ролл-апы используют схему комиссий за газ, подобную Ethereum, чтобы обозначить, сколько пользователи платят за транзакцию. Комиссии, взимаемые в оптимистических ролл-апах, зависят от следующих компонентов:

1. **Запись состояния**: оптимистические ролл-апы публикуют данные транзакций и заголовки блоков (состоящие из хэша заголовка предыдущего блока, корня состояния, корня пакета) в Ethereum в виде `блоба`, или "двоичного большого объекта". [EIP-4844](https://eips.ethereum.org/EIPS/eip-4844) представил экономически эффективное решение для включения данных в сеть. `blob` — это новое поле транзакции, которое позволяет ролл-апам публиковать сжатые данные о переходе состояния в Ethereum L1. В отличие от `calldata`, которая остается в сети постоянно, блобы недолговечны и могут быть удалены из клиентов после [4096 эпох](https://github.com/ethereum/consensus-specs/blob/81f3ea8322aff6b9fb15132d050f8f98b16bdba4/configs/mainnet.yaml#L147) (примерно 18 дней). Используя блобы для публикации пакетов сжатых транзакций, оптимистические ролл-апы могут значительно снизить стоимость записи транзакций в L1.

2. **Использованный газ для блобов**: транзакции, переносящие блобы, используют динамический механизм комиссий, аналогичный тому, что был введен [EIP-1559](https://eips.ethereum.org/EIPS/eip-1559). Комиссия за газ для транзакций типа 3 учитывает базовую комиссию для блобов, которая определяется сетью на основе спроса на пространство для блобов и использования пространства для блобов отправляемой транзакцией.

3. **Комиссии оператора L2**: это сумма, выплачиваемая узлам ролл-апа в качестве компенсации за вычислительные затраты, понесенные при обработке транзакций, подобно комиссиям за газ в Ethereum. Узлы ролл-апа взимают более низкие комиссии за транзакции, поскольку L2 имеют более высокие мощности обработки и не сталкиваются с перегрузками сети, которые заставляют валидаторов в Ethereum отдавать приоритет транзакциям с более высокими комиссиями.

Оптимистические ролл-апы применяют несколько механизмов для снижения комиссий для пользователей, включая пакетирование транзакций и сжатие `calldata` для снижения затрат на публикацию данных. Вы можете проверить [трекер комиссий L2](https://l2fees.info/) для получения обзора в реальном времени о том, сколько стоит использование оптимистических ролл-апов на базе Ethereum.

## Как оптимистические ролл-апы масштабируют Ethereum? {#scaling-ethereum-with-optimistic-rollups}

Как уже объяснялось, оптимистические ролл-апы публикуют сжатые данные транзакций в Ethereum, чтобы гарантировать доступность данных. Возможность сжимать данные, публикуемые в сети, имеет решающее значение для масштабирования пропускной способности Ethereum с помощью оптимистических ролл-апов.

Основная цепь Ethereum устанавливает ограничения на объем данных, которые могут содержать блоки, выраженные в единицах газа ([средний размер блока](/developers/docs/blocks/#block-size) составляет 15 миллионов газа). Хотя это ограничивает, сколько газа может использовать каждая транзакция, это также означает, что мы можем увеличить количество обрабатываемых транзакций в блоке за счет уменьшения данных, связанных с транзакциями, что напрямую улучшает масштабируемость.

Оптимистические ролл-апы используют несколько техник для достижения сжатия данных транзакций и повышения скорости TPS. Например, в этой [статье](https://vitalik.eth.limo/general/2021/01/05/rollup.html) сравниваются данные, которые генерирует базовая пользовательская транзакция (отправка эфира) в основной сети, с объемом данных, который та же транзакция генерирует в ролл-апе:

| Параметр    | Ethereum (L1)                     | Ролл-ап (L2)      |
| ----------- | ---------------------------------------------------- | ------------------------------------ |
| Нонс        | ~3                                   | 0                                    |
| Цена газа   | ~8                                   | 0-0.5                |
| Газ         | 3                                                    | 0-0.5                |
| Получатель  | 21                                                   | 4                                    |
| Значение    | 9                                                    | ~3                   |
| Подпись     | ~68 (2 + 33 + 33) | ~0.5 |
| Отправитель | 0 (восстановлено из подписи)      | 4                                    |
| **Всего**   | **~112 байт**                        | **~12 байтов**       |

Проведение некоторых грубых расчетов на основе этих цифр может помочь показать улучшения масштабируемости, предоставляемые оптимистическим ролл-апом:

1. Целевой размер каждого блока составляет 15 миллионов газа, и проверка одного байта данных стоит 16 газа. Разделив средний размер блока на 16 газа (15 000 000 / 16), мы видим, что средний блок может вместить **937 500 байт данных**.
2. Если базовая транзакция ролл-апа использует 12 байт, то средний блок Ethereum может обработать **78 125 транзакций ролл-апа** (937 500 / 12) или **39 пакетов ролл-апа** (если каждый пакет содержит в среднем 2000 транзакций).
3. Если новый блок создается в Ethereum каждые 15 секунд, то скорость обработки ролл-апа составит примерно **5208 транзакций в секунду**. Это делается путем деления количества базовых транзакций ролл-апа, которое может вместить блок Ethereum (**78 125**), на среднее время блока (**15 секунд**).

Это довольно оптимистичная оценка, учитывая, что транзакции оптимистического ролл-апа не могут полностью занимать весь блок в Ethereum. Однако это может дать приблизительное представление о том, насколько оптимистические ролл-апы могут повысить масштабируемость для пользователей Ethereum (текущие реализации предлагают до 2000 TPS).

Ожидается, что введение [шардинга данных](/roadmap/danksharding/) в Ethereum улучшит масштабируемость в оптимистических ролл-апах. Поскольку транзакции ролл-апа должны делить пространство блока с другими транзакциями, не относящимися к ролл-апу, их пропускная способность ограничена пропускной способностью данных в основной цепи Ethereum. Danksharding увеличит пространство, доступное для цепей L2 для публикации данных в блоке, используя более дешевое, временное хранилище "блобов" вместо дорогого, постоянного `CALLDATA`.

### Плюсы и минусы оптимистических ролл-апов {#optimistic-rollups-pros-and-cons}

| Преимущества                                                                                                                                                                                                                  | Недостатки                                                                                                                                                                                                               |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Предлагает значительные улучшения в масштабируемости без ущерба для безопасности или бездоверительности.                                                                                                      | Задержки в окончательности транзакций из-за потенциальных оспариваний мошенничества.                                                                                                                     |
| Данные транзакций хранятся на цепи уровня 1, что улучшает прозрачность, безопасность, устойчивость к цензуре и децентрализацию.                                                                               | Централизованные операторы ролл-апов (Секвенсоры) могут влиять на порядок транзакций.                                                                                                 |
| Доказательство мошенничества гарантирует бездоверительную окончательность и позволяет честным меньшинствам обеспечивать безопасность цепи.                                                                    | Если нет честных узлов, злонамеренный оператор может украсть средства, публикуя недействительные блоки и фиксации состояний.                                                                             |
| Вычисление доказательств мошенничества открыто для обычных узлов L2, в отличие от доказательств действительности (используемых в ZK-ролл-апах), которые требуют специального оборудования. | Модель безопасности основана на том, что по крайней мере один честный узел выполняет транзакции ролл-апа и отправляет доказательства мошенничества для оспаривания недействительных переходов состояний. |
| Ролл-апы выигрывают от «бездоверительной живучести» (любой может заставить цепь продвигаться, выполняя транзакции и публикуя утверждения).                                                 | Пользователи должны ждать истечения недельного периода оспаривания, прежде чем выводить средства обратно в Ethereum.                                                                                     |
| Оптимистические ролл-апы полагаются на хорошо продуманные криптоэкономические стимулы для повышения безопасности цепи.                                                                                        | Ролл-апы должны публиковать все данные транзакций в сети, что может увеличить затраты.                                                                                                                   |
| Совместимость с EVM и Solidity позволяет разработчикам переносить нативные смарт-контракты Ethereum в ролл-апы или использовать существующие инструменты для создания новых децентрализованных приложений.    |                                                                                                                                                                                                                          |

### Визуальное объяснение оптимистических ролл-апов {#optimistic-video}

Больше увлекаетесь визуализацией? Посмотрите, как Finematics объясняет оптимистические ролл-апы:

<YouTube id="7pWxCklcNsU" start="263" />

## Дополнительные материалы об оптимистических ролл-апах

- [Как работают оптимистические ролл-апы (полное руководство)](https://www.alchemy.com/overviews/optimistic-rollups)
- [Что такое ролл-ап в блокчейне? Техническое введение](https://www.ethereum-ecosystem.com/blog/what-is-a-blockchain-rollup-a-technical-introduction)
- [Основное руководство по Arbitrum](https://www.bankless.com/the-essential-guide-to-arbitrum)
- [Практическое руководство по ролл-апам Ethereum](https://web.archive.org/web/20241108192208/https://research.2077.xyz/the-practical-guide-to-ethereum-rollups)
- [Состояние доказательств мошенничества в Ethereum L2](https://web.archive.org/web/20241124154627/https://research.2077.xyz/the-state-of-fraud-proofs-in-ethereum-l2s)
- [Как на самом деле работает ролл-ап Optimism?](https://www.paradigm.xyz/2021/01/how-does-optimism-s-rollup-really-work)
- [Глубокое погружение в OVM](https://medium.com/ethereum-optimism/ovm-deep-dive-a300d1085f52)
- [Что такое Optimistic Virtual Machine?](https://www.alchemy.com/overviews/optimistic-virtual-machine)
