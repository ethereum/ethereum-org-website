name: Translate JSX Attributes

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch name to process (e.g., translations/es-2024-12-17)"
        required: true
        type: string
      target_language:
        description: "Target language code (e.g., es, fr, de)"
        required: true
        type: string
      file_pattern:
        description: "Glob pattern for files to process (default: all markdown in translations folder)"
        required: false
        default: "public/content/translations/**/*.md"
        type: string
      verbose:
        description: "Enable verbose logging?"
        required: false
        default: false
        type: boolean

jobs:
  translate_attributes:
    runs-on: ubuntu-latest
    steps:
      - name: Check out branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Find markdown files
        id: find-files
        run: |
          FILES=$(find ${{ github.event.inputs.file_pattern }} -type f 2>/dev/null | head -500 | tr '\n' ',')
          echo "files=${FILES%,}" >> $GITHUB_OUTPUT
          echo "Found files: ${FILES%,}"

      - name: Translate JSX attributes
        if: steps.find-files.outputs.files != ''
        run: |
          npx ts-node -O '{"module":"commonjs"}' ./src/scripts/i18n/translate-jsx-attributes.ts \
            --language ${{ github.event.inputs.target_language }} \
            --files "${{ steps.find-files.outputs.files }}"
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          I18N_CROWDIN_API_KEY: ${{ secrets.CROWDIN_WORKFLOW_API_KEY }}

      - name: Commit changes
        if: steps.find-files.outputs.files != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: translate JSX attributes (${{ github.event.inputs.target_language }})"
            git push
            echo "âœ“ Committed and pushed JSX attribute translations"
          fi
